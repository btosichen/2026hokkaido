<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ—æµ·é“ 5 å¤©æ—…éŠè¶£</title>
    
    <!-- å¼•å…¥ Tailwind CSS (æ¨£å¼æ¡†æ¶) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Leaflet CSS (åœ°åœ–æ¨£å¼) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- è¨­å®šå­—å‹èˆ‡å…¨åŸŸæ¨£å¼ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F3F4F6; /* æ·ºç°èƒŒæ™¯ */
            -webkit-tap-highlight-color: transparent;
        }

        /* éš±è—æ²è»¸ä½†ä¿æŒæ»¾å‹•åŠŸèƒ½ (ç¾è§€ç”¨) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* åº•éƒ¨å°èˆªæ¬„ç‰¹æ•ˆ */
        .nav-item.active {
            color: #2563EB; /* Tailwind blue-600 */
        }
        .nav-item.active span {
            font-weight: 700;
        }

        /* åœ°åœ–é«˜åº¦è¨­å®š */
        #map {
            height: calc(100vh - 140px); /* æ‰£é™¤ Header å’Œ Footer */
            width: 100%;
            z-index: 0;
        }
        
        /* å‹•ç•«æ•ˆæœ */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- é ‚éƒ¨æ¨™é¡Œåˆ— -->
    <header class="bg-blue-500 text-white p-4 shadow-md flex-none z-20">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                â„ï¸ åŒ—æµ·é“æ—…éŠè¶£
            </h1>
            <button onclick="toggleMockLocation()" class="text-xs bg-white/20 px-2 py-1 rounded hover:bg-white/30 transition">
                ğŸ“ æ¨¡æ“¬å®šä½
            </button>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ (å¯æ»¾å‹•) -->
    <main id="app-content" class="flex-1 overflow-y-auto relative scroll-smooth no-scrollbar">
        
        <!-- 1ï¸âƒ£ é¦–é è¦–åœ– (Home View) -->
        <div id="view-home" class="p-4 space-y-6 fade-in pb-24">
            <!-- æ­¡è¿å¡ç‰‡ -->
            <div class="bg-gradient-to-r from-blue-400 to-cyan-300 rounded-2xl p-6 text-white shadow-lg">
                <p class="text-sm opacity-90">ç›®å‰ä½ç½®</p>
                <h2 id="current-location-text" class="text-2xl font-bold mt-1">ğŸ‡¯ğŸ‡µ å°šæœªå®šä½</h2>
                <div class="mt-4 flex gap-3">
                    <button onclick="switchTab('map', 'food')" class="flex-1 bg-white/20 backdrop-blur-sm py-2 rounded-lg text-sm font-medium hover:bg-white/30 transition">ğŸœ æ‰¾ç¾é£Ÿ</button>
                    <button onclick="switchTab('map', 'store')" class="flex-1 bg-white/20 backdrop-blur-sm py-2 rounded-lg text-sm font-medium hover:bg-white/30 transition">ğŸª æ‰¾è¶…å•†</button>
                    <button onclick="switchTab('map', 'shopping')" class="flex-1 bg-white/20 backdrop-blur-sm py-2 rounded-lg text-sm font-medium hover:bg-white/30 transition">ğŸ›ï¸ ä¼´æ‰‹ç¦®</button>
                </div>
            </div>

            <!-- è¡Œç¨‹æ™‚é–“è»¸ -->
            <div>
                <h3 class="font-bold text-lg mb-3 text-gray-700">ğŸ—“ï¸ 5 å¤©è¡Œç¨‹ç¸½è¦½</h3>
                <div class="space-y-3" id="itinerary-list">
                    <!-- JS æœƒå‹•æ…‹ç”¢ç”Ÿè¡Œç¨‹å¡ç‰‡ -->
                </div>
            </div>
        </div>

        <!-- 2ï¸âƒ£ åœ°åœ–è¦–åœ– (Map View) -->
        <div id="view-map" class="hidden h-full flex flex-col relative fade-in">
            <!-- ç¯©é¸æŒ‰éˆ• (æ‡¸æµ®) -->
            <div class="absolute top-2 left-0 right-0 z-[1000] px-2">
                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                    <button onclick="filterMap('all')" class="map-filter px-4 py-1.5 bg-white shadow-md rounded-full text-sm whitespace-nowrap border border-gray-200 active-filter font-bold text-blue-600 ring-2 ring-blue-500">å…¨éƒ¨</button>
                    <button onclick="filterMap('food')" class="map-filter px-4 py-1.5 bg-white shadow-md rounded-full text-sm whitespace-nowrap border border-gray-200">ğŸœ ç¾é£Ÿ</button>
                    <button onclick="filterMap('spot')" class="map-filter px-4 py-1.5 bg-white shadow-md rounded-full text-sm whitespace-nowrap border border-gray-200">ğŸ“¸ æ™¯é»</button>
                    <button onclick="filterMap('shopping')" class="map-filter px-4 py-1.5 bg-white shadow-md rounded-full text-sm whitespace-nowrap border border-gray-200">ğŸ›ï¸ è³¼ç‰©</button>
                    <button onclick="filterMap('store')" class="map-filter px-4 py-1.5 bg-white shadow-md rounded-full text-sm whitespace-nowrap border border-gray-200">ğŸª è¶…å•†</button>
                </div>
            </div>
            
            <!-- åœ°åœ–å®¹å™¨ -->
            <div id="map" class="w-full h-full bg-gray-200"></div>

            <!-- åº•éƒ¨è³‡è¨Šå¡ (é»æ“Šåœ°æ¨™å¾Œé¡¯ç¤º) -->
            <div id="map-card" class="absolute bottom-4 left-4 right-4 bg-white p-4 rounded-xl shadow-2xl z-[1000] hidden transform transition-all duration-300 translate-y-0">
                <div class="flex justify-between items-start">
                    <div>
                        <span id="card-type" class="text-xs font-bold px-2 py-0.5 rounded bg-blue-100 text-blue-600">é¡å‹</span>
                        <h3 id="card-title" class="text-lg font-bold mt-1 text-gray-800">åœ°é»åç¨±</h3>
                        <p id="card-desc" class="text-sm text-gray-500 mt-1 line-clamp-2">æè¿°</p>
                    </div>
                    <button onclick="closeMapCard()" class="text-gray-400 hover:text-gray-600">âœ•</button>
                </div>
                <div class="mt-4 flex gap-2">
                    <a id="card-google-btn" href="#" target="_blank" class="flex-1 bg-blue-600 text-white text-center py-2 rounded-lg text-sm font-bold shadow hover:bg-blue-700 transition">
                        ğŸ—ºï¸ Google å°èˆª
                    </a>
                    <button id="card-fav-btn" class="px-3 py-2 border border-gray-300 rounded-lg text-gray-500 hover:bg-gray-50">
                        â¤ï¸
                    </button>
                </div>
            </div>
        </div>

        <!-- 3ï¸âƒ£ æ¢ç´¢/åˆ†é¡è¦–åœ– (Explore View) -->
        <div id="view-explore" class="hidden p-4 space-y-4 fade-in pb-24">
            <h2 class="text-xl font-bold text-gray-800">ğŸ” æ¢ç´¢é¡åˆ¥</h2>
            
            <!-- æœå°‹æ¡† -->
            <div class="relative">
                <input type="text" id="search-input" placeholder="æœå°‹æ‹‰éºµã€ä¼´æ‰‹ç¦®..." class="w-full p-3 pl-10 rounded-xl border-none shadow-sm bg-white focus:ring-2 focus:ring-blue-400 outline-none">
                <span class="absolute left-3 top-3 text-gray-400">ğŸ”</span>
            </div>

            <!-- åˆ†é¡æ¨™ç±¤ -->
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-orange-100 p-4 rounded-xl cursor-pointer hover:bg-orange-200 transition" onclick="showCategory('food')">
                    <span class="text-2xl">ğŸ›</span>
                    <span class="font-bold text-orange-800 ml-2">å¿…åƒç¾é£Ÿ</span>
                </div>
                <div class="bg-pink-100 p-4 rounded-xl cursor-pointer hover:bg-pink-200 transition" onclick="showCategory('shopping')">
                    <span class="text-2xl">ğŸ›ï¸</span>
                    <span class="font-bold text-pink-800 ml-2">è³¼ç‰©è¡€æ‹¼</span>
                </div>
                <div class="bg-green-100 p-4 rounded-xl cursor-pointer hover:bg-green-200 transition" onclick="showCategory('spot')">
                    <span class="text-2xl">ğŸ—»</span>
                    <span class="font-bold text-green-800 ml-2">è‡ªç„¶æ™¯è§€</span>
                </div>
                <div class="bg-blue-100 p-4 rounded-xl cursor-pointer hover:bg-blue-200 transition" onclick="showCategory('store')">
                    <span class="text-2xl">ğŸª</span>
                    <span class="font-bold text-blue-800 ml-2">è¶…å•†è£œçµ¦</span>
                </div>
            </div>

            <!-- åˆ—è¡¨å€åŸŸ -->
            <div id="explore-list" class="space-y-3 mt-4">
                <!-- JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

    </main>

    <!-- åº•éƒ¨å°èˆªæ¬„ -->
    <nav class="bg-white border-t border-gray-200 flex justify-around items-center p-2 pb-safe fixed bottom-0 w-full z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center p-2 w-full text-gray-400 hover:text-blue-500 transition">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span class="text-xs">é¦–é </span>
        </button>
        <button onclick="switchTab('map')" class="nav-item flex flex-col items-center p-2 w-full text-gray-400 hover:text-blue-500 transition">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0121 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
            <span class="text-xs">åœ°åœ–</span>
        </button>
        <button onclick="switchTab('explore')" class="nav-item flex flex-col items-center p-2 w-full text-gray-400 hover:text-blue-500 transition">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            <span class="text-xs">æ¢ç´¢</span>
        </button>
    </nav>

    <!-- å¼•å…¥ Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. è³‡æ–™å±¤ (Data Layer) ---
        // ä½¿ç”¨ JSON æ ¼å¼ï¼Œæ–¹ä¾¿å­¸ç”Ÿç·´ç¿’èˆ‡æ“´å……
        const hokkaidoPlaces = [
            { id: 1, name: "å¤§é€šå…¬åœ’ (é›»è¦–å¡”)", type: "spot", city: "æœ­å¹Œ", lat: 43.0611, lng: 141.3564, note: "æœ­å¹Œçš„åœ°æ¨™ï¼Œå¿…æ‹é›»è¦–å¡”ï¼Œå†¬å¤©æœ‰é›ªç¥­ã€‚", icon: "ğŸ—¼" },
            { id: 2, name: "ç‹¸å°è·¯å•†åº—è¡—", type: "shopping", city: "æœ­å¹Œ", lat: 43.0567, lng: 141.3542, note: "è¶…é•·å•†åº—è¡—ï¼Œè—¥å¦åº—ã€å”å‰è¨¶å¾·éƒ½åœ¨é€™ã€‚", icon: "ğŸ›ï¸" },
            { id: 3, name: "Seicomart (å¤§é€šåº—)", type: "store", city: "æœ­å¹Œ", lat: 43.0590, lng: 141.3510, note: "åŒ—æµ·é“ç¥ç´šè¶…å•†ï¼å¿…åƒç‚¸é›èˆ‡å“ˆå¯†ç“œå†°ã€‚", icon: "ğŸª" },
            { id: 4, name: "å°æ¨½é‹æ²³", type: "spot", city: "å°æ¨½", lat: 43.1976, lng: 141.0028, note: "æµªæ¼«çš„é‹æ²³å¤œæ™¯ï¼Œæ—é‚Šæœ‰å¾ˆå¤šç»ç’ƒé¤¨ã€‚", icon: "ğŸ›¶" },
            { id: 5, name: "LeTAO æœ¬åº—", type: "food", city: "å°æ¨½", lat: 43.1912, lng: 141.0065, note: "é›™å±¤ä¹³é…ªè›‹ç³•æ˜¯æ¥µå“ï¼Œä¸€å®šè¦è©¦åƒã€‚", icon: "ğŸ°" },
            { id: 6, name: "å‡½é¤¨å±±å¤œæ™¯", type: "spot", city: "å‡½é¤¨", lat: 41.7600, lng: 140.7143, note: "ä¸–ç•Œä¸‰å¤§å¤œæ™¯ä¹‹ä¸€ï¼Œçºœè»Šä¸Šå±±å¾ˆå£¯è§€ã€‚", icon: "ğŸŒƒ" },
            { id: 7, name: "å¹¸é‹å°ä¸‘æ¼¢å ¡", type: "food", city: "å‡½é¤¨", lat: 41.7656, lng: 140.7176, note: "åªæœ‰å‡½é¤¨æ‰æœ‰çš„æ¼¢å ¡åº—ï¼Œä»½é‡è¶…å¤§ã€‚", icon: "ğŸ”" },
            { id: 8, name: "æ—­å±±å‹•ç‰©åœ’", type: "spot", city: "æ—­å·", lat: 43.7667, lng: 142.4800, note: "å†¬å¤©å¯ä»¥çœ‹åˆ°ä¼éµæ•£æ­¥ï¼", icon: "ğŸ§" },
            { id: 9, name: "æˆå‰æ€æ±—çƒ¤è‚‰", type: "food", city: "æœ­å¹Œ", lat: 43.0551, lng: 141.3514, note: "åŒ—æµ·é“å¿…åƒç¾Šè‚‰ç‡’çƒ¤ï¼Œé…å•¤é…’çµ•è®šã€‚", icon: "ğŸ¥©" },
            { id: 10, name: "æ–°åƒæ­²æ©Ÿå ´", type: "shopping", city: "åƒæ­²", lat: 42.7875, lng: 141.6814, note: "è¶…å¥½é€›çš„æ©Ÿå ´ï¼Œæœ€å¾Œè£œè²¨éƒ½åœ¨é€™ã€‚", icon: "âœˆï¸" }
        ];

        // ç°¡å–®çš„è¡Œç¨‹å®‰æ’ (Mapping Day to Places)
        const itinerary = [
            { day: "Day 1", title: "æŠµé”æœ­å¹Œ", desc: "å¸‚å€è§€å…‰èˆ‡æ¡è²·è£œçµ¦", color: "bg-blue-100", spots: [1, 2, 9] },
            { day: "Day 2", title: "å°æ¨½æµªæ¼«éŠ", desc: "é‹æ²³æ•£ç­–èˆ‡ç”œé»ä¹‹æ—…", color: "bg-pink-100", spots: [4, 5] },
            { day: "Day 3", title: "æ—­å·æ¢éšª", desc: "å‹•ç‰©åœ’ä¸€æ—¥éŠ", color: "bg-green-100", spots: [8, 3] },
            { day: "Day 4", title: "ç§»å‹•è‡³å‡½é¤¨", desc: "æ¬£è³ç™¾è¬å¤œæ™¯", color: "bg-purple-100", spots: [6, 7] },
            { day: "Day 5", title: "æœ€å¾Œè¡åˆº", desc: "æ©Ÿå ´å¤§æ¡è³¼", color: "bg-orange-100", spots: [10] }
        ];

        // --- 2. é‚è¼¯å±¤ (Logic Layer) ---
        let map;
        let markers = [];
        let userFavorites = new Set(); // ä½¿ç”¨ Set å„²å­˜ ID

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            renderItinerary();
            renderExploreList(hokkaidoPlaces);
            initMap();
            
            // æœå°‹ç›£è½
            document.getElementById('search-input').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = hokkaidoPlaces.filter(p => p.name.toLowerCase().includes(term) || p.note.includes(term));
                renderExploreList(filtered);
            });
        });

        // åˆ‡æ›åˆ†é  (Tabs)
        function switchTab(tabName, filterType = null) {
            // éš±è—æ‰€æœ‰è¦–åœ–
            ['home', 'map', 'explore'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
            });
            
            // ç§»é™¤å°èˆªæ¿€æ´»ç‹€æ…‹
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

            // é¡¯ç¤ºç›®æ¨™è¦–åœ–
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            
            // æ¿€æ´»å°èˆªæŒ‰éˆ• (é€™è£¡ç°¡å–®ç”¨ Index åˆ¤æ–·ï¼Œå¯¦éš›å¯å„ªåŒ–)
            const navIndex = tabName === 'home' ? 0 : tabName === 'map' ? 1 : 2;
            document.querySelectorAll('.nav-item')[navIndex].classList.add('active');

            // ç‰¹æ®Šè™•ç†ï¼šå¦‚æœæ˜¯åœ°åœ–ï¼Œéœ€è¦ resize ç¢ºä¿æ¸²æŸ“æ­£ç¢º
            if (tabName === 'map') {
                setTimeout(() => {
                    map.invalidateSize();
                    if (filterType) filterMap(filterType);
                }, 100);
            }
        }

        // --- æ¸²æŸ“é¦–é è¡Œç¨‹ ---
        function renderItinerary() {
            const list = document.getElementById('itinerary-list');
            list.innerHTML = itinerary.map((item, index) => {
                const spotNames = item.spots.map(id => {
                    const place = hokkaidoPlaces.find(p => p.id === id);
                    return place ? `<span class="text-xs bg-white/50 px-1.5 py-0.5 rounded mr-1">${place.icon} ${place.name}</span>` : '';
                }).join('');

                return `
                    <div class="flex items-stretch gap-4">
                        <div class="flex flex-col items-center">
                            <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-sm shadow">${index + 1}</div>
                            <div class="w-0.5 bg-gray-200 flex-1 my-1"></div>
                        </div>
                        <div class="flex-1 ${item.color} p-4 rounded-xl mb-2 shadow-sm cursor-pointer hover:shadow-md transition" onclick="showDayDetail(${index})">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-gray-800">${item.day}ï¼š${item.title}</h4>
                            </div>
                            <p class="text-xs text-gray-600 mt-1 mb-2">${item.desc}</p>
                            <div class="flex flex-wrap gap-1">
                                ${spotNames}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showDayDetail(dayIndex) {
            // é€™è£¡å¯ä»¥åšå°è¦½åˆ°è©²æ—¥ç¬¬ä¸€å€‹æ™¯é»çš„åœ°åœ–
            const firstSpotId = itinerary[dayIndex].spots[0];
            const spot = hokkaidoPlaces.find(p => p.id === firstSpotId);
            if (spot) {
                switchTab('map');
                setTimeout(() => {
                    map.setView([spot.lat, spot.lng], 14);
                    openMapCard(spot);
                }, 300);
            }
        }

        // --- åœ°åœ–é‚è¼¯ ---
        function initMap() {
            // é è¨­ä¸­å¿ƒé»ï¼šæœ­å¹Œ
            map = L.map('map').setView([43.0618, 141.3545], 11);

            // ä½¿ç”¨ OpenStreetMap åœ–ç£š (å…è²»)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // è¼‰å…¥æ‰€æœ‰æ™¯é»
            renderMarkers(hokkaidoPlaces);
        }

        function renderMarkers(places) {
            // æ¸…é™¤èˆŠæ¨™è¨˜
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            places.forEach(place => {
                // è‡ªå®šç¾© Icon (ç°¡å–®ç”¨ DivIcon é¡¯ç¤º Emoji)
                const myIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="font-size: 24px; text-shadow: 2px 2px 0px white;">${place.icon}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const marker = L.marker([place.lat, place.lng], { icon: myIcon }).addTo(map);
                
                // é»æ“Šäº‹ä»¶
                marker.on('click', () => {
                    openMapCard(place);
                    map.setView([place.lat, place.lng], 15);
                });
                
                markers.push(marker);
            });
        }

        function filterMap(type) {
            // UI æŒ‰éˆ•ç‹€æ…‹æ›´æ–°
            document.querySelectorAll('.map-filter').forEach(btn => {
                if ((type === 'all' && btn.innerText.includes('å…¨éƒ¨')) || btn.innerText.includes(getCategoryName(type))) {
                    btn.classList.add('active-filter', 'font-bold', 'text-blue-600', 'ring-2', 'ring-blue-500');
                } else {
                    btn.classList.remove('active-filter', 'font-bold', 'text-blue-600', 'ring-2', 'ring-blue-500');
                }
            });

            // è³‡æ–™éæ¿¾
            const filtered = type === 'all' 
                ? hokkaidoPlaces 
                : hokkaidoPlaces.filter(p => p.type === type);
            
            renderMarkers(filtered);

            // è‡ªå‹•ç¸®æ”¾ä»¥é¡¯ç¤ºæ‰€æœ‰é»
            if (filtered.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function openMapCard(place) {
            const card = document.getElementById('map-card');
            const googleUrl = `https://www.google.com/maps/search/?api=1&query=${place.lat},${place.lng}`;
            
            document.getElementById('card-type').innerText = getCategoryName(place.type);
            document.getElementById('card-title').innerText = `${place.icon} ${place.name}`;
            document.getElementById('card-desc').innerText = place.note;
            document.getElementById('card-google-btn').href = googleUrl;
            
            // è¨­å®šæ”¶è—æŒ‰éˆ•ç‹€æ…‹
            const favBtn = document.getElementById('card-fav-btn');
            updateFavBtnStyle(favBtn, place.id);
            favBtn.onclick = () => toggleFavorite(place.id, favBtn);

            card.classList.remove('hidden');
            card.classList.remove('translate-y-full');
        }

        function closeMapCard() {
            document.getElementById('map-card').classList.add('hidden');
        }

        // --- æ¢ç´¢é é‚è¼¯ ---
        function renderExploreList(list) {
            const container = document.getElementById('explore-list');
            if (list.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-10">æ‰¾ä¸åˆ°åœ°é»...</div>';
                return;
            }

            container.innerHTML = list.map(place => {
                const isFav = userFavorites.has(place.id);
                return `
                    <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="text-3xl bg-gray-100 w-12 h-12 flex items-center justify-center rounded-lg">${place.icon}</div>
                            <div>
                                <h4 class="font-bold text-gray-800">${place.name}</h4>
                                <p class="text-xs text-gray-500">${place.city} Â· ${getCategoryName(place.type)}</p>
                            </div>
                        </div>
                        <button onclick="toggleFavorite(${place.id}, this)" class="text-2xl transition ${isFav ? 'text-red-500 transform scale-110' : 'text-gray-300'}">
                            ${isFav ? 'â¤ï¸' : 'ğŸ¤'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function showCategory(type) {
            document.getElementById('search-input').value = getCategoryName(type);
            const filtered = hokkaidoPlaces.filter(p => p.type === type);
            renderExploreList(filtered);
        }

        // --- å…±ç”¨å·¥å…· ---
        function getCategoryName(type) {
            const map = {
                'food': 'ç¾é£Ÿ',
                'shopping': 'è³¼ç‰©',
                'spot': 'æ™¯é»',
                'store': 'è¶…å•†'
            };
            return map[type] || 'å…¶ä»–';
        }

        function toggleFavorite(id, btnElement) {
            if (userFavorites.has(id)) {
                userFavorites.delete(id);
                if (btnElement.tagName === 'BUTTON') {
                    btnElement.innerText = 'ğŸ¤';
                    btnElement.classList.remove('text-red-500', 'scale-110');
                    btnElement.classList.add('text-gray-300');
                }
            } else {
                userFavorites.add(id);
                if (btnElement.tagName === 'BUTTON') {
                    btnElement.innerText = 'â¤ï¸';
                    btnElement.classList.remove('text-gray-300');
                    btnElement.classList.add('text-red-500', 'scale-110');
                }
            }
            // å¦‚æœåœ¨ Explore é é¢ï¼Œåˆ·æ–°ä¸€ä¸‹åˆ—è¡¨ä»¥ä¿æŒç‹€æ…‹åŒæ­¥ (å¯é¸)
        }

        function toggleMockLocation() {
            const el = document.getElementById('current-location-text');
            if (el.innerText.includes('æœ­å¹Œ')) {
                el.innerText = 'ğŸ‡¯ğŸ‡µ å°šæœªå®šä½';
            } else {
                el.innerText = 'ğŸ“ æœ­å¹Œå¸‚ä¸­å¤®å€';
                // æ¨¡æ“¬ç§»å‹•åœ°åœ–
                if(map) map.setView([43.0611, 141.3564], 14);
            }
        }
        
        // ä¿®æ­£ Fav æŒ‰éˆ•æ¨£å¼ (Map card ç”¨)
        function updateFavBtnStyle(btn, id) {
            if (userFavorites.has(id)) {
                btn.innerText = 'â¤ï¸';
                btn.classList.add('bg-red-50', 'border-red-200');
            } else {
                btn.innerText = 'ğŸ¤';
                btn.classList.remove('bg-red-50', 'border-red-200');
            }
        }

    </script>
</body>
</html>

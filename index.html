<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026åŒ—æµ·é“æ—…éŠå…¨æ”»ç•¥ App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        :root { font-size: 16px; --app-height: 100vh; }
        @media (min-width: 768px) { :root { font-size: 18px; } }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            height: var(--app-height);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .nav-item.active { color: #2563EB; }
        .nav-item.active svg { fill: currentColor; fill-opacity: 0.2; }
        .nav-item.active span { font-weight: 700; }

        #map { height: 100%; width: 100%; z-index: 0; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.1); }
        
        .input-field {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 1px solid #e2e8f0; background: #fff;
            font-size: 1.1rem; outline: none; transition: all 0.2s;
        }
        .input-field:focus { border-color: #3b82f6; ring: 2px solid #93c5fd; }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        /* è¡Œç¨‹æ¨™ç±¤æ¨£å¼ */
        .tag-eat { @apply bg-orange-100 text-orange-700 border-orange-200; }
        .tag-buy { @apply bg-pink-100 text-pink-700 border-pink-200; }
        .tag-snap { @apply bg-blue-100 text-blue-700 border-blue-200; }
        
        /* èªéŸ³æŒ‰éˆ•æ•ˆæœ */
        .phrase-card:active { transform: scale(0.98); background-color: #eff6ff; }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-blue-600 text-white p-4 shadow-md flex-none z-20 flex justify-between items-center">
        <h1 class="text-2xl font-bold tracking-wide">â„ï¸ åŒ—æµ·é“æ”»ç•¥</h1>
        <div class="text-sm bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm">
            åŒ¯ç‡ç´„ 0.22
        </div>
    </header>

    <main id="app-content" class="flex-1 overflow-y-auto relative scroll-smooth no-scrollbar bg-gray-50">
        
        <!-- 1ï¸âƒ£ é¦–é  -->
        <div id="view-home" class="p-5 space-y-6 fade-in pb-24">
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 text-white card-shadow">
                <h2 class="text-3xl font-bold mb-2">æ—…é€”æ„‰å¿«ï¼</h2>
                <p class="opacity-90 text-lg">ä»Šå¤©æƒ³æ¢ç´¢å“ªè£¡ï¼Ÿ</p>
                <div class="mt-6 grid grid-cols-2 gap-3">
                    <button onclick="switchTab('itinerary')" class="bg-white/20 hover:bg-white/30 p-3 rounded-xl text-left transition border border-white/10">
                        <span class="text-2xl block mb-1">ğŸ—“ï¸</span>
                        <span class="font-bold">5å¤©è¡Œç¨‹è¡¨</span>
                    </button>
                    <button onclick="switchTab('money')" class="bg-white/20 hover:bg-white/30 p-3 rounded-xl text-left transition border border-white/10">
                        <span class="text-2xl block mb-1">ğŸ’°</span>
                        <span class="font-bold">è¨˜å¸³/åŒ¯ç‡</span>
                    </button>
                </div>
            </div>

            <div>
                <h3 class="font-bold text-xl text-gray-700 mb-3 ml-1">ğŸ”— å¯¦ç”¨é€£çµ</h3>
                <div class="grid grid-cols-1 gap-3" id="links-container"></div>
            </div>
        </div>

        <!-- 2ï¸âƒ£ åœ°åœ– -->
        <div id="view-map" class="hidden h-full flex flex-col relative fade-in">
            <div class="absolute top-4 left-0 right-0 z-[1000] px-3">
                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2 px-1">
                    <button onclick="filterMap('all')" class="map-filter px-5 py-2 bg-white shadow-lg rounded-full text-base border active-filter font-bold text-blue-600 ring-2 ring-blue-500">å…¨éƒ¨</button>
                    <button onclick="filterMap('food')" class="map-filter px-5 py-2 bg-white shadow-lg rounded-full text-base border text-gray-700">ğŸœ ç¾é£Ÿ</button>
                    <button onclick="filterMap('toy')" class="map-filter px-5 py-2 bg-white shadow-lg rounded-full text-base border text-gray-700">ğŸ» å‹•æ¼«/èŒç‰©</button>
                    <button onclick="filterMap('shopping')" class="map-filter px-5 py-2 bg-white shadow-lg rounded-full text-base border text-gray-700">ğŸ›ï¸ ä¼´æ‰‹ç¦®</button>
                    <button onclick="filterMap('spot')" class="map-filter px-5 py-2 bg-white shadow-lg rounded-full text-base border text-gray-700">ğŸ“¸ æ™¯é»</button>
                </div>
            </div>
            <div id="map" class="bg-gray-200"></div>
            <div id="map-card" class="absolute bottom-6 left-4 right-4 bg-white p-5 rounded-2xl shadow-2xl z-[1000] hidden transform translate-y-full transition-transform duration-300">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span id="card-type" class="text-sm font-bold px-2 py-1 rounded bg-blue-100 text-blue-700">é¡å‹</span>
                        <h3 id="card-title" class="text-2xl font-bold mt-1">åœ°é»</h3>
                    </div>
                    <button onclick="closeMapCard()" class="text-gray-400 text-2xl p-1">âœ•</button>
                </div>
                <p id="card-desc" class="text-gray-600 mb-4 text-lg">æè¿°</p>
                <div class="flex gap-3">
                    <a id="card-google" href="#" target="_blank" class="flex-1 bg-blue-600 text-white text-center py-3 rounded-xl font-bold text-lg shadow hover:bg-blue-700">
                        åœ¨ Google åœ°åœ–é–‹å•Ÿ
                    </a>
                    <button onclick="addToExpenseFromCard()" class="bg-green-100 text-green-700 px-4 rounded-xl text-2xl border border-green-200">
                        ğŸ’°
                    </button>
                </div>
            </div>
        </div>

        <!-- 3ï¸âƒ£ æ¢ç´¢ -->
        <div id="view-explore" class="hidden p-5 space-y-4 fade-in pb-24">
            <h2 class="text-2xl font-bold text-gray-800">ğŸ” å€åŸŸèˆ‡åˆ†é¡</h2>
            <div class="relative">
                <input type="text" id="search-input" placeholder="æœå°‹ æ¹¯å’–å“©ã€åˆéŸ³ã€æœ¨åˆ€..." class="w-full p-4 pl-12 rounded-xl border-none shadow-sm bg-white text-lg">
                <span class="absolute left-4 top-4 text-gray-400 text-xl">ğŸ”</span>
            </div>
            <div class="flex gap-2">
                <button onclick="filterExplore('toy')" class="flex-1 bg-purple-100 text-purple-900 py-3 rounded-xl font-bold text-lg border border-purple-200">ğŸ» å‹•æ¼«/èŒç‰©</button>
                <button onclick="filterExplore('food')" class="flex-1 bg-orange-100 text-orange-900 py-3 rounded-xl font-bold text-lg border border-orange-200">ğŸœ ç‰¹è‰²ç¾é£Ÿ</button>
            </div>
            <div id="explore-list" class="space-y-4 mt-2"></div>
        </div>

        <!-- 4ï¸âƒ£ è¡Œç¨‹ -->
        <div id="view-itinerary" class="hidden p-5 space-y-6 fade-in pb-24">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ—“ï¸ 5 å¤©è¡Œç¨‹æ”»ç•¥</h2>
            
            <div class="mb-6 bg-white rounded-2xl overflow-hidden shadow-md border border-gray-100">
                <div class="bg-blue-50 p-3 border-b border-blue-100 flex justify-between items-center">
                    <h3 class="font-bold text-blue-800 flex items-center gap-2">
                        <span>ğŸ—ºï¸</span> è¡Œç¨‹åœ°åœ–
                    </h3>
                    <span class="text-xs text-gray-500">2026 Hokkaido</span>
                </div>
                <div class="relative">
                    <img src="https://raw.githubusercontent.com/btosichen/2026hokkaido/19be6130cefe0cc97d19ab3ea7b01727e9875c1e/Gemini_Generated_Image_rcqrv3rcqrv3rcqr.PNG" 
                         alt="åŒ—æµ·é“5å¤©è¡Œç¨‹åœ°åœ–" 
                         class="w-full h-auto object-cover"
                         style="min-height: 200px; background-color: #f0f0f0;"
                         onerror="this.style.display='none'; document.getElementById('map-link-fallback').classList.remove('hidden');">
                    
                    <div id="map-link-fallback" class="hidden p-8 text-center bg-gray-50">
                        <p class="mb-2 text-gray-500">åœ–ç‰‡æš«æ™‚ç„¡æ³•é¡¯ç¤º</p>
                        <a href="https://github.com/btosichen/2026hokkaido/blob/19be6130cefe0cc97d19ab3ea7b01727e9875c1e/Gemini_Generated_Image_rcqrv3rcqrv3rcqr.PNG" 
                           target="_blank" 
                           class="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg font-bold shadow hover:bg-blue-700">
                            é»æ­¤å‰å¾€æŸ¥çœ‹åœ°åœ–
                        </a>
                    </div>
                </div>
            </div>

            <div id="itinerary-container" class="space-y-6">
                <!-- JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- 5ï¸âƒ£ è¨˜å¸³ -->
        <div id="view-money" class="hidden p-5 space-y-6 fade-in pb-24">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-500 mb-2">ğŸ‡¯ğŸ‡µ åŒ¯ç‡è©¦ç®— (0.22)</h3>
                <div class="flex items-center gap-3">
                    <div class="flex-1 relative">
                        <span class="absolute left-3 top-3 text-gray-400 font-bold">Â¥</span>
                        <input type="number" id="jpy-input" placeholder="æ—¥å¹£" class="w-full p-3 pl-8 bg-gray-50 rounded-xl text-xl font-bold outline-none" oninput="calculateRate()">
                    </div>
                    <span class="text-2xl text-gray-400">â</span>
                    <div class="flex-1 relative">
                        <span class="absolute left-3 top-3 text-gray-400 font-bold">NT$</span>
                        <input type="text" id="twd-output" placeholder="å°å¹£" readonly class="w-full p-3 pl-12 bg-gray-100 rounded-xl text-xl font-bold text-blue-600 outline-none">
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-lg border border-blue-100 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-blue-500"></div>
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                    ğŸ“ æ–°å¢ä¸€ç­†èŠ±è²»
                </h3>
                
                <div id="sheet-setup-box" class="mb-4 p-3 bg-yellow-50 text-yellow-800 text-sm rounded-lg hidden">
                    <p class="font-bold mb-1">âš ï¸ è¨­å®šé€£çµ</p>
                    <input type="text" id="sheet-url-input" placeholder="Apps Script URL" class="w-full p-2 border rounded mb-2">
                    <button onclick="saveSheetUrl()" class="bg-yellow-500 text-white px-3 py-1 rounded font-bold w-full">æ›´æ–°é€£çµ</button>
                </div>

                <div class="space-y-3">
                    <input type="date" id="expense-date" class="input-field">
                    <input type="text" id="expense-item" placeholder="å“é … / åœ°é»" class="input-field">
                    <input type="number" id="expense-amount" placeholder="é‡‘é¡ (æ—¥å¹£ Â¥)" class="input-field">
                    
                    <button onclick="addExpense()" class="w-full bg-blue-600 text-white py-4 rounded-xl text-xl font-bold shadow-md hover:bg-blue-700 active:scale-95 transition">
                        æ–°å¢ç´€éŒ„
                    </button>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-end mb-3">
                    <h3 class="font-bold text-xl text-gray-700">ä»Šæ—¥èŠ±è²»</h3>
                    <div class="flex items-center gap-2">
                        <button onclick="clearLocalRecords()" class="text-xs bg-red-100 text-red-600 px-3 py-1.5 rounded-lg border border-red-200 font-bold hover:bg-red-200 transition">
                            ğŸ—‘ï¸ æ¸…é™¤æ‰‹æ©Ÿåˆ—è¡¨
                        </button>
                        <span class="text-2xl font-bold text-blue-600">Â¥ <span id="total-amount">0</span></span>
                    </div>
                </div>
                <div id="expense-list" class="space-y-2"></div>
                
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <button id="sync-btn" onclick="syncToGoogleSheet()" class="bg-green-500 text-white py-3 rounded-xl font-bold shadow opacity-50 cursor-not-allowed" disabled>
                        â˜ï¸ åŒæ­¥ä¸Šå‚³
                    </button>
                    <button onclick="fetchCloudRecords()" class="bg-indigo-500 text-white py-3 rounded-xl font-bold shadow hover:bg-indigo-600">
                        ğŸ“‹ ç€è¦½ç´€éŒ„
                    </button>
                </div>
                <button onclick="toggleSetupBox()" class="text-xs text-gray-400 mt-2 w-full text-center underline">æª¢æŸ¥é€£çµè¨­å®š</button>
            </div>
        </div>

        <!-- 6ï¸âƒ£ å·¥å…· -->
        <div id="view-tools" class="hidden p-5 space-y-6 fade-in pb-24">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">ğŸ‡¯ğŸ‡µ åŒ—æµ·é“ç”Ÿå­˜æŒ‡æŒ‡é€š</h2>
            <p class="text-sm text-gray-500 mb-4">é»æ“Šå¡ç‰‡å¯æ’­æ”¾/æ”¾å¤§æ–‡å­—</p>

            <div class="space-y-5" id="phrase-book">
                <!-- JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

    </main>

    <!-- Modal -->
    <div id="cloud-history-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
            <div class="bg-indigo-600 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-xl">â˜ï¸ Google è©¦ç®—è¡¨ç´€éŒ„</h3>
                <button onclick="closeCloudHistory()" class="text-white text-2xl px-2">âœ•</button>
            </div>
            <div id="cloud-history-content" class="p-4 overflow-y-auto flex-1 bg-gray-50">
                <div class="flex justify-center py-10">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div>
                </div>
            </div>
            <div class="p-3 border-t bg-white text-center text-sm text-gray-500">
                è‹¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèª Apps Script æ¬Šé™èˆ‡ä»£ç¢¼
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆª -->
    <nav class="bg-white border-t flex justify-around items-center px-1 py-2 pb-safe fixed bottom-0 w-full z-30 shadow-2xl text-gray-400">
        <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center p-2 w-full transition">
            <svg class="w-7 h-7 mb-1" viewBox="0 0 24 24"><path d="M12 3L4 9v12h5v-7h6v7h5V9z" fill="currentColor"/></svg>
            <span class="text-xs">é¦–é </span>
        </button>
        <button onclick="switchTab('map')" class="nav-item flex flex-col items-center p-2 w-full transition">
            <svg class="w-7 h-7 mb-1" viewBox="0 0 24 24"><path d="M20.5 3l-6 1.5-6-1.5L2 4.5v15l6.5-1.5 6 1.5 6-1.5v-15zm-6 12v-7l5-1.25v13.25l-5 1.25zm-11-1.25V5.25l5-1.25v13.25l-5 1.25z" fill="currentColor"/></svg>
            <span class="text-xs">åœ°åœ–</span>
        </button>
        <button onclick="switchTab('explore')" class="nav-item flex flex-col items-center p-2 w-full transition">
            <svg class="w-7 h-7 mb-1" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z" fill="currentColor"/></svg>
            <span class="text-xs">æ¢ç´¢</span>
        </button>
        <button onclick="switchTab('itinerary')" class="nav-item flex flex-col items-center p-2 w-full transition">
            <svg class="w-7 h-7 mb-1" viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" fill="currentColor"/></svg>
            <span class="text-xs">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('money')" class="nav-item flex flex-col items-center p-2 w-full transition">
            <svg class="w-7 h-7 mb-1" viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z" fill="currentColor"/></svg>
            <span class="text-xs">è¨˜å¸³</span>
        </button>
        <button onclick="switchTab('tools')" class="nav-item flex flex-col items-center p-2 w-full transition">
            <svg class="w-7 h-7 mb-1" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" fill="currentColor"/></svg>
            <span class="text-xs">å·¥å…·</span>
        </button>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. è³‡æ–™åº« (Places & Itinerary) ---
        const places = [
            { id: 1, name: "å¤§é€šå…¬åœ’", type: "spot", area: "æœ­å¹Œä¸­å¿ƒ", lat: 43.0611, lng: 141.3564, note: "æœ­å¹Œåœ°æ¨™é›»è¦–å¡”", icon: "ğŸ—¼", rating: 4.5 },
            { id: 2, name: "ç‹¸å°è·¯å•†åº—è¡—", type: "shopping", area: "ç‹¸å°è·¯", lat: 43.0567, lng: 141.3542, note: "è—¥å¦ã€å”å‰è¨¶å¾·ã€ä¼´æ‰‹ç¦®", icon: "ğŸ›ï¸", rating: 4.2 },
            { id: 3, name: "äºŒæ¢å¸‚å ´", type: "food", area: "æœ­å¹Œä¸­å¿ƒ", lat: 43.0583, lng: 141.3582, note: "æµ·é®®ä¸¼é£¯æ—©é¤é¦–é¸", icon: "ğŸ¦€", rating: 4.1 },
            { id: 4, name: "å°æ¨½é‹æ²³", type: "spot", area: "å°æ¨½", lat: 43.1976, lng: 141.0028, note: "æµªæ¼«å¤œæ™¯å¿…æ‹", icon: "ğŸ›¶", rating: 4.4 },
            { id: 26, name: "ä¸‰äº• OUTLET", type: "shopping", area: "åŒ—å»£å³¶", lat: 42.9698, lng: 141.4627, note: "åç‰ŒæŠ˜æ‰£ï¼Œå¥½é€›å¥½è²·", icon: "ğŸ¬", rating: 4.1 },
            { id: 301, name: "LeTAO æœ¬åº—", type: "food", area: "å°æ¨½", lat: 43.1912, lng: 141.0065, note: "å¿…åƒé›™å±¤ä¹³é…ªè›‹ç³• (Double Fromage)", icon: "ğŸ°", rating: 4.8 },
            { id: 302, name: "åŒ—è“æ¨“ å°æ¨½æœ¬é¤¨", type: "food", area: "å°æ¨½", lat: 43.1930, lng: 141.0082, note: "ã€Œå¤¢ä¸æ€è­°ã€å¤§æ³¡èŠ™ã€å¦–ç²¾ä¹‹æ£®å¹´è¼ªè›‹ç³•", icon: "ğŸ¦", rating: 4.6 },
            { id: 303, name: "è‹¥é›æ™‚ä»£ Naruto", type: "food", area: "å°æ¨½", lat: 43.1956, lng: 140.9942, note: "å°æ¨½åç‰©ï¼šè¶…å¤§ç‚¸åŠé›å®šé£Ÿ", icon: "ğŸ—", rating: 4.4 },
            { id: 304, name: "Suage+ æ¹¯å’–å“©", type: "food", area: "æœ­å¹Œä¸­å¿ƒ", lat: 43.0555, lng: 141.3533, note: "åŒ—æµ·é“éˆé­‚ç¾é£Ÿï¼Œä¸²ç‡’çŸ¥åºŠé›", icon: "ğŸ›", rating: 4.5 },
            { id: 305, name: "æœ­å¹Œå•¤é…’åœ’", type: "food", area: "æœ­å¹Œæ±å€", lat: 43.0712, lng: 141.3695, note: "æˆå‰æ€æ±—çƒ¤ç¾Šè‚‰åƒåˆ°é£½ï¼Œå•¤é…’å¥½å–", icon: "ğŸ¥©", rating: 4.3 },
            { id: 306, name: "å…­èŠ±äº­ æœ­å¹Œæœ¬åº—", type: "shopping", area: "æœ­å¹Œè»Šç«™", lat: 43.0635, lng: 141.3498, note: "å¿…è²·ï¼šè˜­å§†è‘¡è„å¥¶æ²¹å¤¾å¿ƒé¤…ä¹¾", icon: "ğŸª", rating: 4.7 },
            { id: 307, name: "Wakasaimo æœ¬èˆ–", type: "food", area: "æ´çˆºæ¹–", lat: 42.5562, lng: 140.8190, note: "æ´çˆºåç”¢ï¼šå‡è£æ˜¯åœ°ç“œçš„è±†æ²™ç”œé»", icon: "ğŸ ", rating: 4.0 },
            { id: 401, name: "è¶Šå¾Œå±‹ (æ´çˆºæ¹–æœ¨åˆ€)", type: "toy", area: "æ´çˆºæ¹–", lat: 42.5663, lng: 140.8260, note: "ã€ŠéŠ€é­‚ã€‹å‚ç”°éŠ€æ™‚æ„›ç”¨æœ¨åˆ€ï¼Œå¯åˆ»å­—", icon: "ğŸ—¡ï¸", rating: 4.5 },
            { id: 402, name: "é›ªæœªä¾† Sky Town", type: "toy", area: "æ–°åƒæ­²æ©Ÿå ´", lat: 42.7875, lng: 141.6814, note: "åˆéŸ³è¿·è–åœ°ï¼ŒåŒ—æµ·é“é™å®š Snow Miku", icon: "â„ï¸", rating: 4.7 },
            { id: 403, name: "å°æ¨½éŸ³æ¨‚ç›’å ‚", type: "spot", area: "å°æ¨½", lat: 43.1906, lng: 141.0076, note: "é–€å£è’¸æ°£é˜æ˜¯åœ°æ¨™ï¼Œä¹Ÿæ˜¯ã€Šé»ƒé‡‘ç¥å¨ã€‹å ´æ™¯", icon: "ğŸ¼", rating: 4.6 },
            { id: 404, name: "å“ˆå¯†ç“œç†Š (å¤•å¼µ)", type: "toy", area: "å…¶ä»–", lat: 43.0560, lng: 141.9700, note: "é•·ç›¸å…‡æ®˜çš„åœ¨åœ°å‰ç¥¥ç‰©", icon: "ğŸ»", rating: 3.8 },
            { id: 104, name: "PokÃ©mon Center Sapporo", type: "toy", area: "æœ­å¹Œè»Šç«™", lat: 43.0686, lng: 141.3508, note: "å°‹æ‰¾åŒ—æµ·é“å¤§ä½¿ã€Œé˜¿ç¾…æ‹‰å…­å°¾ã€", icon: "âš¡", rating: 4.6 },
            { id: 101, name: "Animate æœ­å¹Œåº—", type: "toy", area: "æœ­å¹Œä¸­å¿ƒ", lat: 43.0605, lng: 141.3535, note: "å‹•æ¼«å‘¨é‚Šï¼Œå¥³æ€§å‘å¤š", icon: "ğŸ“˜", rating: 4.3 },
            { id: 102, name: "Mandarake æœ­å¹Œåº—", type: "toy", area: "ç‹¸å°è·¯", lat: 43.0565, lng: 141.3525, note: "äºŒæ‰‹çµ•ç‰ˆå“æŒ–å¯¶", icon: "ğŸº", rating: 4.0 },
            { id: 103, name: "é§¿æ²³å±‹ æœ­å¹Œåº—", type: "toy", area: "æœ­å¹Œè»Šç«™", lat: 43.0675, lng: 141.3510, note: "äºŒæ‰‹æ¨¡å‹å…¬ä»”", icon: "ğŸ“¦", rating: 3.9 },
            { id: 105, name: "Yodobashi Camera", type: "toy", area: "æœ­å¹Œè»Šç«™", lat: 43.0690, lng: 141.3480, note: "3F æ¨¡å‹å€æ¥µå¤§ï¼Œé‹¼å½ˆé½Šå…¨", icon: "ğŸ¤–", rating: 4.5 },
            { id: 201, name: "æœ­å¹Œ PARCO", type: "shopping", area: "æœ­å¹Œä¸­å¿ƒ", lat: 43.0595, lng: 141.3530, note: "Jump Shop åœ¨é€™ (æµ·è³Šç‹/æ’çƒå°‘å¹´)", icon: "ğŸ‘—", rating: 4.1 },
            { id: 202, name: "Stellar Place", type: "shopping", area: "æœ­å¹Œè»Šç«™", lat: 43.0685, lng: 141.3505, note: "èˆ‡è»Šç«™å…±æ§‹ï¼Œè¶…å¤§è³¼ç‰©ä¸­å¿ƒ", icon: "ğŸ¬", rating: 4.3 },
        ];

        const fullItinerary = [
            {
                day: "Day 1",
                title: "é“å—è‡ªç„¶é¢¨å…‰",
                desc: "å‡½é¤¨æ©Ÿå ´æŠµé” â” é«”é©—ç•°åœ‹é¢¨æƒ…èˆ‡è‡ªç„¶ç¾æ™¯",
                hotel: { name: "ç™»åˆ¥è¬ä¸–é–£ (Noboribetsu Manseikaku)", url: "https://maps.app.goo.gl/uK9EwJJVUyrXnpr28" },
                spots: [
                    { name: "ç™¾å¹´å¥³å­ä¿®é“é™¢", url: "https://www.google.com/maps/search/?api=1&query=Trappistine+Monastery", type: "snap", note: "å¿…åƒï¼šé–€å£è²©è³£éƒ¨çš„éœœæ·‡æ·‹ (è™Ÿç¨±åŒ—æµ·é“æœ€æ¿ƒ)ã€‚<br>å¿…æ‹ï¼šæ­é¢¨åº­åœ’èˆ‡ç´…ç£šå»ºç¯‰ã€‚" },
                    { name: "å¤§æ²¼åœ‹å®šå…¬åœ’", url: "https://www.google.com/maps/search/?api=1&query=Onuma+Quasi-National+Park", type: "snap", note: "å¿…åƒï¼šæ²¼ä¹‹å®¶ (æ²¼ã®å®¶) çš„é†¬æ²¹/ç´…è±†ç³°å­ã€‚<br>å¿…æ‹ï¼šé§’ä¹‹å²³å€’æ˜ åœ¨æ¹–é¢çš„æ™¯è‰²ã€‚" },
                    { name: "æ´çˆºæ¹–å±•æœ›å°", url: "https://www.google.com/maps/search/?api=1&query=Lake+Toya+Observatory", type: "snap", note: "å¿…æ‹ï¼šçœºæœ›æ´çˆºæ¹–å…¨æ™¯èˆ‡ä¸­å³¶ã€‚<br>å¿…åƒï¼šWakasaimo (ã‚ã‹ã•ã„ã‚‚) ç”œé»ã€‚" },
                    { name: "ç™»åˆ¥æº«æ³‰ Hotel", url: "https://maps.app.goo.gl/uK9EwJJVUyrXnpr28", type: "eat", note: "å¿…åƒï¼šé£¯åº—è‡ªåŠ©é¤èƒèŸ¹åƒåˆ°é£½ã€‚<br>å¿…æ‹ï¼šåœ°ç„è°·ç…™éœ§ç¹šç¹çš„æ™¯è±¡ã€‚" }
                ]
            },
            {
                day: "Day 2",
                title: "å°æ¨½æµªæ¼«æ¼«éŠ",
                desc: "æ¼«æ­¥é‹æ²³ç•” â” ç”œé»èˆ‡ç»ç’ƒå·¥è—ä¹‹æ—…",
                hotel: { name: "APA HOTEL & RESORT SAPPORO", url: "https://maps.app.goo.gl/hor1bNPWLVe8tK3w5" },
                spots: [
                    { name: "å°æ¨½é‹æ²³", url: "https://www.google.com/maps/search/?api=1&query=Otaru+Canal", type: "snap", note: "å¿…æ‹ï¼šæ·ºè‰æ©‹ä¸Šæ‹æ”å€‰åº«ç¾¤å€’å½±ï¼Œæ™šä¸Šé»ç‡ˆæ›´ç¾ã€‚" },
                    { name: "åŒ—ä¸€ç¡å­é¤¨", url: "https://www.google.com/maps/search/?api=1&query=Kitaichi+Glass", type: "buy", note: "å¿…è²·ï¼šç²¾ç·»çš„ç»ç’ƒæ¯ã€ç…¤æ²¹ç‡ˆã€‚<br>å¿…æ‹ï¼šä¸‰è™Ÿé¤¨å…§çš„ç…¤æ²¹ç‡ˆå’–å•¡å»³ã€‚" },
                    { name: "å°æ¨½éŸ³æ¨‚ç›’å ‚", url: "https://www.google.com/maps/search/?api=1&query=Otaru+Music+Box+Museum", type: "buy", note: "å¿…è²·ï¼šå¤©ä½¿é€ å‹éŸ³æ¨‚ç›’ã€‚<br>å¿…æ‹ï¼šé–€å£çš„ä¸–ç•Œæœ€å¤§è’¸æ°£é˜ (æ•´é»å ±æ™‚)ã€‚" },
                    { name: "LeTAO / åŒ—è“æ¨“", url: "https://www.google.com/maps/search/?api=1&query=LeTAO+Main+Store", type: "eat", note: "å¿…åƒï¼šLeTAO é›™å±¤ä¹³é…ªè›‹ç³•ã€åŒ—è“æ¨“ã€Œå¤¢ä¸æ€è­°ã€æ³¡èŠ™ã€å…­èŠ±äº­æ³¡èŠ™ã€‚" }
                ]
            },
            {
                day: "Day 3",
                title: "æœ­å¹Œåå‹å·¡ç¦®",
                desc: "å¸‚å€è§€å…‰ â” åƒæ‹œç¥å®®èˆ‡å·§å…‹åŠ›å·¥å» ",
                hotel: { name: "APA HOTEL & RESORT SAPPORO (é€£æ³Š)", url: "https://maps.app.goo.gl/hor1bNPWLVe8tK3w5" },
                spots: [
                    { name: "åŒ—æµ·é“ç¥å®®", url: "https://www.google.com/maps/search/?api=1&query=Hokkaido+Jingu", type: "snap", note: "å¿…è²·ï¼šæ‹‰æ‹‰ç†Šç¹ªé¦¬ã€ç¥å®®é™å®šçš„ã€Œåˆ¤å®˜é¤…ã€(ç¾çƒ¤)ã€‚<br>å¿…æ‹ï¼šèŠåš´çš„é³¥å±…èˆ‡åƒé“ã€‚" },
                    { name: "ç™½è‰²æˆ€äººå…¬åœ’", url: "https://www.google.com/maps/search/?api=1&query=Shiroi+Koibito+Park", type: "snap", note: "å¿…è²·ï¼šç™½è‰²æˆ€äººå·§å…‹åŠ›ã€å¹´è¼ªè›‹ç³•ã€‚<br>å¿…æ‹ï¼šæ­é¢¨ç«ç‘°èŠ±åœ’èˆ‡æ•´é»ç©å¶éŠè¡Œã€‚" },
                    { name: "æœ­å¹Œå·¥å» ", url: "https://www.google.com/maps/search/?api=1&query=Sapporo+Factory", type: "buy", note: "å¿…æ‹ï¼šå·¨å¤§çš„ç´…ç£šå»ºç¯‰èˆ‡æº«å®¤ä¸­åº­ã€‚<br>å¿…é€›ï¼šæˆ¶å¤–ç”¨å“åº— (Mont-bell ç­‰)ã€‚" },
                    { name: "ç‹¸å°è·¯å•†åº—è¡—", url: "https://www.google.com/maps/search/?api=1&query=Tanukikoji+Shopping+Street", type: "buy", note: "å¿…è²·ï¼šè—¥å¦ (å¤§åœ‹/æ¾æœ¬æ¸…)ã€å”å‰è¨¶å¾·ä¼´æ‰‹ç¦®ã€‚<br>å¿…åƒï¼šæ¹¯å’–å“© (Suage+ æˆ– GARAKU)ã€‚" }
                ]
            },
            {
                day: "Day 4",
                title: "è³¼ç‰©èˆ‡ç™¾è¬å¤œæ™¯",
                desc: "Outlet è¡€æ‹¼ â” ç§»å‹•è‡³å‡½é¤¨è³å¤œæ™¯",
                hotel: { name: "å‡½é¤¨ç«™å‰æ ¼è˜­å¸äº ROUTE INN", url: "https://maps.app.goo.gl/3NMakum7WcFbCMh49" },
                spots: [
                    { name: "ä¸‰äº• OUTLET", url: "https://www.google.com/maps/search/?api=1&query=Mitsui+Outlet+Park+Sapporo+Kitahiroshima", type: "buy", note: "å¿…è²·ï¼šé‹å‹•å“ç‰Œ (Nike/Adidas)ã€æ—¥ç³»æœé£¾ã€LCé‹å…·ã€‚<br>å¿…åƒï¼šç¾é£Ÿè¡—çš„è±šä¸¼ã€‚" },
                    { name: "é‡‘æ£®ç´…ç£šå€‰åº«", url: "https://www.google.com/maps/search/?api=1&query=Kanemori+Red+Brick+Warehouse", type: "snap", note: "å¿…æ‹ï¼šæ¸¯é‚Šç´…ç£šå€‰åº«ç¾¤ã€‚<br>å¿…åƒï¼šSnaffle's èµ·å¸è›‹ç³• (Catchcakes)ã€‚" },
                    { name: "å¹¸é‹å°ä¸‘æ¼¢å ¡", url: "https://www.google.com/maps/search/?api=1&query=Lucky+Pierrot", type: "eat", note: "å¿…åƒï¼šä¸­è¯é›è…¿æ¼¢å ¡ (å…¨æ—¥æœ¬æœ€å¥½åƒæ¼¢å ¡)ï¼Œåªæœ‰å‡½é¤¨æœ‰ï¼" },
                    { name: "å‡½é¤¨å±±å¤œæ™¯", url: "https://www.google.com/maps/search/?api=1&query=Mount+Hakodate", type: "snap", note: "å¿…æ‹ï¼šä¸–ç•Œä¸‰å¤§å¤œæ™¯ä¹‹ä¸€ï¼Œç‰¹æ®Šçš„é›™Cæµ·ç£åœ°å½¢ã€‚" }
                ]
            },
            {
                day: "Day 5",
                title: "æµ·é®®ç¾é£Ÿé¥—å®´",
                desc: "å‡½é¤¨æœå¸‚é«”é©— â” æ»¿è¼‰è€Œæ­¸",
                hotel: null, 
                spots: [
                    { name: "å‡½é¤¨å‚³çµ±æœå¸‚", url: "https://www.google.com/maps/search/?api=1&query=Hakodate+Morning+Market", type: "eat", note: "å¿…åƒï¼šç¾é‡£çƒè³Šåˆºèº« (åœ¨é‚£é‚Šé‡£é‚£é‚Šåƒ)ã€æµ·é®®ä¸¼é£¯ã€‚<br>å¿…è²·ï¼šå¹²è²ç³–ã€æ˜†å¸ƒã€‚" },
                    { name: "å‡½é¤¨/åƒæ­²æ©Ÿå ´", url: "https://www.google.com/maps/search/?api=1&query=New+Chitose+Airport", type: "buy", note: "å¿…è²·ï¼šè–¯æ¢ä¸‰å…„å¼Ÿã€Royceå·§å…‹åŠ›ã€åŒ—è¦‹è–„è·æ²¹ã€‚<br>æœ€å¾Œè£œè²¨æ©Ÿæœƒï¼" }
                ]
            }
        ];

        const webLinks = [
            { title: "æ¨‚åƒè³¼ï¼æ—¥æœ¬", desc: "åŒ—æµ·é“è‡ªç”±è¡Œæ”»ç•¥", url: "https://hokkaido.letsgojp.com/archives/659283/", icon: "ğŸ‡¯ğŸ‡µ" },
            { title: "GoodLuckTrip", desc: "åŒ—æµ·é“å¥½é‹æ—¥æœ¬è¡Œ", url: "https://www.gltjp.com/zh-hant/article/item/20775/", icon: "ğŸ€" },
            { title: "è¥¿åŒ—æ—…éŠ", desc: "åŒ—æµ·é“è³¼ç‰©æŒ‡å—", url: "https://northwest-travel.com/japan/hokkaido-travel-shopping/", icon: "ğŸ›ï¸" },
            { title: "Funliday", desc: "ç‹¸å°è·¯è¡Œç¨‹è¦åŠƒ", url: "https://www.funliday.com/posts/tanukikoji/", icon: "ğŸ“" }
        ];

        // --- å¯¦ç”¨æ—¥èªè³‡æ–™ (Updated) ---
        const phrases = [
            {
                category: "ğŸ‘‹ åŸºæœ¬å•å€™",
                items: [
                    { cn: "æ—©å®‰", jp: "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™", roma: "Ohayou gozaimasu" },
                    { cn: "ä½ å¥½ / åˆå®‰", jp: "ã“ã‚“ã«ã¡ã¯", roma: "Konnichiwa" },
                    { cn: "è¬è¬", jp: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™", roma: "Arigatou gozaimasu" },
                    { cn: "ä¸å¥½æ„æ€ / å°ä¸èµ·", jp: "ã™ã¿ã¾ã›ã‚“", roma: "Sumimasen" }
                ]
            },
            {
                category: "ğŸ› é¤å»³é»é¤",
                items: [
                    { cn: "1 ä½", jp: "ã²ã¨ã‚Šã§ã™", roma: "Hitori desu" },
                    { cn: "2 ä½", jp: "ãµãŸã‚Šã§ã™", roma: "Futari desu" },
                    { cn: "4 ä½", jp: "ã‚ˆã«ã‚“ã§ã™", roma: "Yonin desu" },
                    { cn: "æˆ‘è¦é»é¤", jp: "æ³¨æ–‡ãŠé¡˜ã„ã—ã¾ã™", roma: "Chuumon onegaishimasu" },
                    { cn: "æˆ‘è¦é€™å€‹", jp: "ã“ã‚Œã‚’ãã ã•ã„", roma: "Kore o kudasai" },
                    { cn: "æˆ‘è¦ä¸€æ¯ç†±ç¾å¼", jp: "ãƒ›ãƒƒãƒˆã‚³ãƒ¼ãƒ’ãƒ¼ã‚’ã²ã¨ã¤", roma: "Hotto ko-hi- o hitotsu" },
                    { cn: "çµå¸³", jp: "ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™", roma: "Okaikei onegaishimasu" },
                    { cn: "å¾ˆå¥½åƒ", jp: "ãŠã„ã—ã„ã§ã™", roma: "Oishii desu" }
                ]
            },
            {
                category: "ğŸ›ï¸ è³¼ç‰© & å…¶ä»–",
                items: [
                    { cn: "å¤šå°‘éŒ¢ï¼Ÿ", jp: "ã„ãã‚‰ã§ã™ã‹ï¼Ÿ", roma: "Ikura desu ka" },
                    { cn: "å¯ä»¥å…ç¨…å—ï¼Ÿ", jp: "å…ç¨ã§ãã¾ã™ã‹ï¼Ÿ", roma: "Menzei dekimasu ka" },
                    { cn: "è«‹çµ¦æˆ‘è¢‹å­", jp: "è¢‹ã‚’ãã ã•ã„", roma: "Fukuro o kudasai" },
                    { cn: "å»æ‰€åœ¨å“ªè£¡ï¼Ÿ", jp: "ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", roma: "Toire wa doko desu ka" }
                ]
            }
        ];

        let map;
        let markers = [];
        let expenseList = JSON.parse(localStorage.getItem('hokkaido_expenses')) || [];
        
        const DEFAULT_URL = "https://script.google.com/macros/s/AKfycbyGdnxRVEY4_lpRozTYUqmLKP8634VmE_LRpSKsMoTm4H4ATD8b6Bs30PLrpQF4tbE/exec";
        let sheetUrl = localStorage.getItem('hokkaido_sheet_url_custom') === 'true' 
            ? (localStorage.getItem('hokkaido_sheet_url') || DEFAULT_URL) 
            : DEFAULT_URL;

        document.addEventListener('DOMContentLoaded', () => {
            renderLinks();
            renderPhrases(); 
            renderExplore(places);
            renderExpenseList();
            renderItineraryDetails(); 
            initMap();
            
            document.getElementById('expense-date').valueAsDate = new Date();
            document.getElementById('sheet-url-input').value = sheetUrl;

            document.getElementById('search-input').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = places.filter(p => 
                    p.name.toLowerCase().includes(term) || 
                    p.note.includes(term) ||
                    p.type.includes(term)
                );
                renderExplore(filtered);
            });
        });

        function switchTab(tabName, filterType = null) {
            ['home', 'map', 'explore', 'money', 'tools', 'itinerary'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`view-${t}`).classList.remove('flex');
            });
            
            const target = document.getElementById(`view-${tabName}`);
            target.classList.remove('hidden');
            if (tabName === 'map') target.classList.add('flex');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            const navItems = document.querySelectorAll('.nav-item');
            if(tabName === 'home') navItems[0].classList.add('active');
            else if(tabName === 'map') navItems[1].classList.add('active');
            else if(tabName === 'explore') navItems[2].classList.add('active');
            else if(tabName === 'itinerary') navItems[3].classList.add('active');
            else if(tabName === 'money') navItems[4].classList.add('active');
            else if(tabName === 'tools') navItems[5].classList.add('active');

            if (tabName === 'map') {
                setTimeout(() => { 
                    map.invalidateSize(); 
                    if(filterType) filterMap(filterType);
                }, 100);
            }
            if (tabName === 'explore' && filterType) {
                filterExplore(filterType);
            }
        }

        // --- æ¸²æŸ“è¡Œç¨‹ ---
        function renderItineraryDetails() {
            const container = document.getElementById('itinerary-container');
            container.innerHTML = fullItinerary.map((day, index) => {
                let hotelHtml = '';
                if (day.hotel) {
                    hotelHtml = `
                        <div class="mt-4 pt-3 border-t border-gray-100">
                            <p class="text-xs text-gray-500 font-bold mb-1">ğŸŒ™ ä»Šæ™šä½å®¿</p>
                            <a href="${day.hotel.url}" target="_blank" class="flex items-center gap-2 text-indigo-600 font-bold hover:underline">
                                <span>ğŸ¨</span> ${day.hotel.name} <span>âœ</span>
                            </a>
                        </div>
                    `;
                }

                return `
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                    <div class="bg-blue-50 p-4 border-b border-blue-100">
                        <h3 class="font-bold text-xl text-blue-800">${day.day}ï¼š${day.title}</h3>
                        <p class="text-sm text-gray-600 mt-1">${day.desc}</p>
                    </div>
                    <div class="p-4 space-y-4">
                        ${day.spots.map(spot => {
                            let tagClass = "";
                            let tagText = "";
                            if(spot.type === 'eat') { tagClass = "tag-eat"; tagText = "å¿…åƒ"; }
                            else if(spot.type === 'buy') { tagClass = "tag-buy"; tagText = "å¿…è²·"; }
                            else { tagClass = "tag-snap"; tagText = "å¿…æ‹"; }
                            
                            return `
                                <div class="flex gap-3">
                                    <div class="flex-none pt-1">
                                        <span class="text-xs font-bold px-2 py-1 rounded border ${tagClass}">${tagText}</span>
                                    </div>
                                    <div class="flex-1">
                                        <a href="${spot.url}" target="_blank" class="font-bold text-gray-800 text-lg hover:text-blue-600 transition flex items-center gap-1">
                                            ${spot.name} <span class="text-gray-400 text-sm">â†—</span>
                                        </a>
                                        <p class="text-sm text-gray-600 mt-1 leading-relaxed">${spot.note}</p>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        ${hotelHtml}
                    </div>
                </div>
            `;
            }).join('');
        }

        // --- æ¸²æŸ“æ—¥èªé‡‘å¥ ---
        function renderPhrases() {
            const container = document.getElementById('phrase-book');
            container.innerHTML = phrases.map(cat => `
                <div>
                    <h3 class="font-bold text-gray-700 mb-3 ml-1 text-lg">${cat.category}</h3>
                    <div class="grid grid-cols-2 gap-3">
                        ${cat.items.map(p => `
                            <div class="phrase-card bg-white p-3 rounded-xl border border-gray-200 shadow-sm cursor-pointer transition" onclick="speakPhrase('${p.jp}')">
                                <div class="font-bold text-blue-700 text-lg mb-1">${p.cn}</div>
                                <div class="text-xl font-bold text-gray-800 mb-1">${p.jp}</div>
                                <div class="text-xs text-gray-400">${p.roma}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function speakPhrase(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            speechSynthesis.speak(utterance);
        }

        function renderLinks() {
            const container = document.getElementById('links-container');
            container.innerHTML = webLinks.map(link => `
                <a href="${link.url}" target="_blank" class="flex items-center gap-3 bg-white p-4 rounded-xl shadow-sm border border-gray-100 active:bg-gray-50">
                    <div class="text-2xl bg-gray-50 w-12 h-12 flex items-center justify-center rounded-lg">${link.icon}</div>
                    <div class="flex-1">
                        <h4 class="font-bold text-blue-700">${link.title}</h4>
                        <p class="text-sm text-gray-500">${link.desc}</p>
                    </div>
                    <span class="text-gray-300">âœ</span>
                </a>
            `).join('');
        }

        function calculateRate() {
            const jpy = parseFloat(document.getElementById('jpy-input').value) || 0;
            const rate = 0.22;
            document.getElementById('twd-output').value = Math.round(jpy * rate);
        }

        function toggleSetupBox() {
            document.getElementById('sheet-setup-box').classList.toggle('hidden');
        }

        function saveSheetUrl() {
            const url = document.getElementById('sheet-url-input').value;
            if(url) {
                localStorage.setItem('hokkaido_sheet_url', url);
                localStorage.setItem('hokkaido_sheet_url_custom', 'true'); 
                sheetUrl = url;
                alert('é€£çµå·²æ›´æ–°ï¼');
                toggleSetupBox();
            }
        }

        // --- æ¸…é™¤æ‰‹æ©Ÿç´€éŒ„ (æ–°åŠŸèƒ½) ---
        function clearLocalRecords() {
            const unsyncedCount = expenseList.filter(i => !i.synced).length;
            let msg = "ç¢ºå®šè¦æ¸…é™¤æ‰‹æ©Ÿä¸Šçš„æ‰€æœ‰è¨˜å¸³ç´€éŒ„å—ï¼Ÿ\næ­¤æ“ä½œä¸æœƒå½±éŸ¿ Google è©¦ç®—è¡¨ä¸Šçš„è³‡æ–™ã€‚";
            
            if (unsyncedCount > 0) {
                msg = `âš ï¸ æ³¨æ„ï¼šæœ‰ ${unsyncedCount} ç­†è³‡æ–™å°šæœªåŒæ­¥åˆ°é›²ç«¯ï¼\n` + msg + "\n(æ¸…é™¤å¾ŒæœªåŒæ­¥è³‡æ–™å°‡ç„¡æ³•å¾©åŸ)";
            }
            
            if(!confirm(msg)) return;

            expenseList = [];
            localStorage.setItem('hokkaido_expenses', JSON.stringify(expenseList));
            renderExpenseList();
            alert("æ‰‹æ©Ÿç´€éŒ„å·²æ¸…é™¤ï¼");
        }

        function addExpense() {
            const date = document.getElementById('expense-date').value;
            const item = document.getElementById('expense-item').value;
            const amount = document.getElementById('expense-amount').value;

            if (!date || !item || !amount) {
                alert('è«‹å®Œæ•´å¡«å¯«æ—¥æœŸã€å“é …èˆ‡é‡‘é¡');
                return;
            }

            const record = {
                id: Date.now(),
                date: date,
                item: item,
                amount: parseInt(amount),
                synced: false
            };

            expenseList.unshift(record);
            localStorage.setItem('hokkaido_expenses', JSON.stringify(expenseList));
            
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amount').value = '';
            
            renderExpenseList();
            alert(`å·²è¨˜éŒ„ï¼šÂ¥${amount}`);
        }

        function addToExpenseFromCard() {
            const title = document.getElementById('card-title').innerText;
            document.getElementById('expense-item').value = title;
            switchTab('money');
        }

        function renderExpenseList() {
            const container = document.getElementById('expense-list');
            let total = 0;
            let unsyncedCount = 0;

            container.innerHTML = expenseList.map(ex => {
                total += ex.amount;
                if(!ex.synced) unsyncedCount++;
                
                return `
                    <div class="flex justify-between items-center bg-white p-3 rounded-xl border-l-4 ${ex.synced ? 'border-green-400' : 'border-gray-300'} shadow-sm">
                        <div>
                            <div class="font-bold text-gray-800">${ex.item}</div>
                            <div class="text-xs text-gray-500">${ex.date} ${ex.synced ? 'âœ… å·²åŒæ­¥' : 'â˜ï¸ å¾…ä¸Šå‚³'}</div>
                        </div>
                        <div class="font-bold text-lg">Â¥${ex.amount.toLocaleString()}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('total-amount').innerText = total.toLocaleString();
            
            const syncBtn = document.getElementById('sync-btn');
            if (unsyncedCount > 0 && sheetUrl) {
                syncBtn.disabled = false;
                syncBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                syncBtn.innerText = `â˜ï¸ åŒæ­¥ä¸Šå‚³ (${unsyncedCount}ç­†)`;
            } else {
                syncBtn.disabled = true;
                syncBtn.classList.add('opacity-50', 'cursor-not-allowed');
                syncBtn.innerText = sheetUrl ? 'â˜ï¸ æ‰€æœ‰è³‡æ–™å·²åŒæ­¥' : 'âš ï¸ è«‹å…ˆè¨­å®šé€£çµ';
            }
        }

        function syncToGoogleSheet() {
            if (!sheetUrl) { alert('è«‹å…ˆè¨­å®š Google Apps Script URL'); return; }

            const unsyncedData = expenseList.filter(ex => !ex.synced);
            if (unsyncedData.length === 0) return;

            const btn = document.getElementById('sync-btn');
            btn.innerText = "â³ ä¸Šå‚³ä¸­...";
            btn.disabled = true;

            fetch(sheetUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(unsyncedData)
            }).then(() => {
                expenseList.forEach(ex => ex.synced = true);
                localStorage.setItem('hokkaido_expenses', JSON.stringify(expenseList));
                renderExpenseList();
                alert('è³‡æ–™å·²å‚³é€ï¼\nè‹¥è©¦ç®—è¡¨æ²’å‡ºç¾è³‡æ–™ï¼Œè«‹æª¢æŸ¥ Sheet åç¨±æ˜¯å¦ç‚º "Expenses"');
            }).catch(err => {
                console.error(err);
                alert('åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– URL');
                btn.innerText = "åŒæ­¥å¤±æ•— (é‡è©¦)";
                btn.disabled = false;
            });
        }

        function fetchCloudRecords() {
            if (!sheetUrl) { alert('è«‹å…ˆè¨­å®š Google Apps Script URL'); return; }
            
            const modal = document.getElementById('cloud-history-modal');
            const content = document.getElementById('cloud-history-content');
            
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="flex justify-center py-10"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div></div>';
            
            fetch(sheetUrl)
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(data => {
                    if (!data || data.length === 0) {
                        content.innerHTML = '<div class="text-center text-gray-500 py-10">é›²ç«¯è©¦ç®—è¡¨æ˜¯ç©ºçš„</div>';
                        return;
                    }
                    
                    let total = 0;
                    const html = data.map(row => {
                        const amt = parseInt(row.amount) || 0;
                        total += amt;
                        let dateStr = row.date;
                        if(dateStr.includes('T')) dateStr = dateStr.split('T')[0];
                        
                        return `
                            <div class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-200 mb-2 shadow-sm">
                                <div>
                                    <div class="font-bold text-gray-800">${row.item}</div>
                                    <div class="text-xs text-gray-500">${dateStr}</div>
                                </div>
                                <div class="font-bold text-indigo-600">Â¥${amt.toLocaleString()}</div>
                            </div>
                        `;
                    }).join('');
                    
                    content.innerHTML = `
                        <div class="text-right mb-4 font-bold text-gray-700">ç¸½è¨ˆ: Â¥${total.toLocaleString()}</div>
                        ${html}
                    `;
                })
                .catch(err => {
                    console.error(err);
                    content.innerHTML = `
                        <div class="text-center text-red-500 py-6">
                            è®€å–å¤±æ•—<br>
                            <span class="text-xs text-gray-500 block mt-2">è«‹ç¢ºèªæ‚¨çš„ Apps Script å·²æ›´æ–°ç¨‹å¼ç¢¼ï¼Œä¸¦ã€Œéƒ¨ç½²ç‚ºæ–°ç‰ˆæœ¬ã€ã€‚</span>
                        </div>
                    `;
                });
        }
        
        function closeCloudHistory() {
            document.getElementById('cloud-history-modal').classList.add('hidden');
        }

        function initMap() {
            map = L.map('map').setView([43.0618, 141.3545], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OSM'
            }).addTo(map);
            renderMarkers(places);
        }

        function renderMarkers(data) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            data.forEach(p => {
                const icon = L.divIcon({
                    className: '',
                    html: `<div style="font-size:28px; text-shadow:0 2px 4px rgba(0,0,0,0.3)">${p.icon}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                const marker = L.marker([p.lat, p.lng], {icon}).addTo(map);
                marker.on('click', () => {
                    openMapCard(p);
                    map.setView([p.lat, p.lng], 15);
                });
                markers.push(marker);
            });
        }

        function filterMap(type) {
            document.querySelectorAll('.map-filter').forEach(b => {
                if((type==='all' && b.innerText.includes('å…¨éƒ¨')) || b.innerText.includes(getCatName(type))) {
                    b.classList.add('bg-blue-600', 'text-white', 'ring-2');
                    b.classList.remove('bg-white', 'text-gray-700', 'text-blue-600');
                } else {
                    b.classList.remove('bg-blue-600', 'text-white', 'ring-2');
                    b.classList.add('bg-white', 'text-gray-700');
                }
            });
            const filtered = type === 'all' ? places : places.filter(p => p.type === type);
            renderMarkers(filtered);
        }

        function filterExplore(type) {
            document.getElementById('search-input').value = getCatName(type);
            const filtered = places.filter(p => p.type === type);
            renderExplore(filtered);
        }

        function renderExplore(list) {
            const container = document.getElementById('explore-list');
            if(list.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-10">æ‰¾ä¸åˆ°ç›¸é—œåœ°é»...</div>';
                return;
            }
            container.innerHTML = list.map(p => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex gap-4 active:bg-gray-50" onclick="locatePlace(${p.id})">
                    <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center text-4xl">${p.icon}</div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-lg">${p.name}</h4>
                            <span class="text-yellow-500 font-bold text-sm">â˜… ${p.rating}</span>
                        </div>
                        <p class="text-sm text-blue-600 font-bold mb-1">${p.area} Â· ${getCatName(p.type)}</p>
                        <p class="text-sm text-gray-500 line-clamp-1">${p.note}</p>
                    </div>
                </div>
            `).join('');
        }

        function locatePlace(id) {
            const p = places.find(x => x.id === id);
            if(p) {
                switchTab('map');
                setTimeout(() => {
                    map.setView([p.lat, p.lng], 16);
                    openMapCard(p);
                }, 300);
            }
        }

        function openMapCard(p) {
            const card = document.getElementById('map-card');
            document.getElementById('card-type').innerText = getCatName(p.type);
            document.getElementById('card-title').innerText = p.name;
            document.getElementById('card-desc').innerText = p.note;
            document.getElementById('card-google').href = `https://www.google.com/maps/search/?api=1&query=${p.name}`;
            
            card.classList.remove('hidden');
            setTimeout(() => card.classList.remove('translate-y-full'), 10);
        }

        function closeMapCard() {
            const card = document.getElementById('map-card');
            card.classList.add('translate-y-full');
            setTimeout(() => card.classList.add('hidden'), 300);
        }

        function getCatName(type) {
            const map = { 'toy': 'å‹•æ¼«ç©å…·', 'food': 'ç¾é£Ÿ', 'shopping': 'è³¼ç‰©', 'spot': 'æ™¯é»', 'store': 'è¶…å•†' };
            return map[type] || 'å…¶ä»–';
        }
    </script>
</body>
</html>

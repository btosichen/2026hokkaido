<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ—æµ·é“æ—…éŠå…¨æ”»ç•¥ App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        :root { font-size: 16px; --app-height: 100vh; }
        @media (min-width: 768px) { :root { font-size: 18px; } }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            height: var(--app-height);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* éš±è—æ²è»¸ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* å°èˆªæ¨£å¼ */
        .nav-item.active { color: #2563EB; }
        .nav-item.active svg { fill: currentColor; fill-opacity: 0.2; }
        .nav-item.active span { font-weight: 700; }

        /* åœ°åœ–é«˜åº¦ */
        #map { height: 100%; width: 100%; z-index: 0; }
        
        /* å‹•ç•« */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡æ¨£å¼ */
        .card-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.1); }
        
        /* è¨˜å¸³è¡¨å–®æ¨£å¼ */
        .input-field {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 1px solid #e2e8f0; background: #fff;
            font-size: 1.1rem; outline: none; transition: all 0.2s;
        }
        .input-field:focus { border-color: #3b82f6; ring: 2px solid #93c5fd; }

        /* æ¨¡æ…‹è¦–çª— (Modal) */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- é ‚éƒ¨æ¨™é¡Œ -->
    <header class="bg-blue-600 text-white p-4 shadow-md flex-none z-20 flex justify-between items-center">
        <h1 class="text-2xl font-bold tracking-wide">â„ï¸ åŒ—æµ·é“æ”»ç•¥</h1>
        <div class="text-sm bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm">
            åŒ¯ç‡ç´„ 0.22
        </div>
    </header>

    <!-- ä¸»å…§å®¹å€ -->
    <main id="app-content" class="flex-1 overflow-y-auto relative scroll-smooth no-scrollbar bg-gray-50">
        
        <!-- 1ï¸âƒ£ é¦–é  (Home) -->
        <div id="view-home" class="p-5 space-y-6 fade-in pb-24">
            <!-- æ­¡è¿å¡ -->
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 text-white card-shadow">
                <h2 class="text-3xl font-bold mb-2">æ—…é€”æ„‰å¿«ï¼</h2>
                <p class="opacity-90 text-lg">ä»Šå¤©æƒ³æ¢ç´¢å“ªè£¡ï¼Ÿ</p>
                <div class="mt-6 grid grid-cols-2 gap-3">
                    <button onclick="switchTab('explore', 'toy')" class="bg-white/20 hover:bg-white/30 p-3 rounded-xl text-left transition border border-white/10">
                        <span class="text-2xl block mb-1">ğŸ¤–</span>
                        <span class="font-bold">æ¨¡å‹/å‹•æ¼«</span>
                    </button>
                    <button onclick="switchTab('money')" class="bg-white/20 hover:bg-white/30 p-3 rounded-xl text-left transition border border-white/10">
                        <span class="text-2xl block mb-1">ğŸ’°</span>
                        <span class="font-bold">è¨˜å¸³/åŒ¯ç‡</span>
                    </button>
                </div>
            </div>

            <!-- å¯¦ç”¨æ—…éŠé€£çµ -->
            <div>
                <h3 class="font-bold text-xl text-gray-700 mb-3 ml-1">ğŸ”— ç²¾é¸æ—…éŠæŒ‡å—</h3>
                <div class="grid grid-cols-1 gap-3" id="links-container">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- 2ï¸âƒ£ åœ°åœ– (Map) -->
        <div id="view-map" class="hidden h-full flex flex-col relative fade-in">
            <!-- ç¯©é¸ä¸¸å­ -->
            <div class="absolute top-4 left-0 right-0 z-[1000] px-3">
                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2 px-1">
                    <button onclick="filterMap('all')" class="map-filter px-5 py-2 bg-white shadow-lg rounded-full text-base border active-filter font-bold text-blue-600 ring-2 ring-blue-500">å…¨éƒ¨</button>
                    <button onclick="filterMap('toy')" class="map-filter px-5 py-2 bg-white shadow-lg rounded-full text-base border text-gray-700">ğŸ¤– å‹•æ¼«ç©å…·</button>
                    <button onclick="filterMap('food')" class="map-filter px-5 py-2 bg-white shadow-lg rounded-full text-base border text-gray-700">ğŸœ ç¾é£Ÿ</button>
                    <button onclick="filterMap('shopping')" class="map-filter px-5 py-2 bg-white shadow-lg rounded-full text-base border text-gray-700">ğŸ›ï¸ è³¼ç‰©</button>
                    <button onclick="filterMap('spot')" class="map-filter px-5 py-2 bg-white shadow-lg rounded-full text-base border text-gray-700">ğŸ“¸ æ™¯é»</button>
                </div>
            </div>
            <div id="map" class="bg-gray-200"></div>
            <!-- åœ°é»è³‡è¨Šå¡ -->
            <div id="map-card" class="absolute bottom-6 left-4 right-4 bg-white p-5 rounded-2xl shadow-2xl z-[1000] hidden transform translate-y-full transition-transform duration-300">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span id="card-type" class="text-sm font-bold px-2 py-1 rounded bg-blue-100 text-blue-700">é¡å‹</span>
                        <h3 id="card-title" class="text-2xl font-bold mt-1">åœ°é»</h3>
                    </div>
                    <button onclick="closeMapCard()" class="text-gray-400 text-2xl p-1">âœ•</button>
                </div>
                <p id="card-desc" class="text-gray-600 mb-4 text-lg">æè¿°</p>
                <div class="flex gap-3">
                    <a id="card-google" href="#" target="_blank" class="flex-1 bg-blue-600 text-white text-center py-3 rounded-xl font-bold text-lg shadow hover:bg-blue-700">
                        åœ¨ Google åœ°åœ–é–‹å•Ÿ
                    </a>
                    <button onclick="addToExpenseFromCard()" class="bg-green-100 text-green-700 px-4 rounded-xl text-2xl border border-green-200">
                        ğŸ’°
                    </button>
                </div>
            </div>
        </div>

        <!-- 3ï¸âƒ£ å®…åŠ›/æ¢ç´¢ (Explore) -->
        <div id="view-explore" class="hidden p-5 space-y-4 fade-in pb-24">
            <h2 class="text-2xl font-bold text-gray-800">ğŸ” å€åŸŸèˆ‡åˆ†é¡</h2>
            <!-- æœå°‹æ¡† -->
            <div class="relative">
                <input type="text" id="search-input" placeholder="æœå°‹ é‹¼å½ˆã€æ‹‰éºµ..." class="w-full p-4 pl-12 rounded-xl border-none shadow-sm bg-white text-lg">
                <span class="absolute left-4 top-4 text-gray-400 text-xl">ğŸ”</span>
            </div>
            
            <!-- å‹•æ¼«å°ˆå€é–‹é—œ -->
            <div class="flex gap-2">
                <button onclick="filterExplore('toy')" class="flex-1 bg-purple-100 text-purple-900 py-3 rounded-xl font-bold text-lg border border-purple-200">ğŸ¤– å‹•æ¼«/æ¨¡å‹</button>
                <button onclick="filterExplore('food')" class="flex-1 bg-orange-100 text-orange-900 py-3 rounded-xl font-bold text-lg border border-orange-200">ğŸœ å¿…åƒç¾é£Ÿ</button>
            </div>

            <div id="explore-list" class="space-y-4 mt-2">
                <!-- JS ç”Ÿæˆ -->
            </div>
        </div>

        <!-- 4ï¸âƒ£ è¨˜å¸³/åŒ¯ç‡ (Money) -->
        <div id="view-money" class="hidden p-5 space-y-6 fade-in pb-24">
            <!-- åŒ¯ç‡è¨ˆç®— -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-500 mb-2">ğŸ‡¯ğŸ‡µ åŒ¯ç‡è©¦ç®— (0.22)</h3>
                <div class="flex items-center gap-3">
                    <div class="flex-1 relative">
                        <span class="absolute left-3 top-3 text-gray-400 font-bold">Â¥</span>
                        <input type="number" id="jpy-input" placeholder="æ—¥å¹£" class="w-full p-3 pl-8 bg-gray-50 rounded-xl text-xl font-bold outline-none" oninput="calculateRate()">
                    </div>
                    <span class="text-2xl text-gray-400">â</span>
                    <div class="flex-1 relative">
                        <span class="absolute left-3 top-3 text-gray-400 font-bold">NT$</span>
                        <input type="text" id="twd-output" placeholder="å°å¹£" readonly class="w-full p-3 pl-12 bg-gray-100 rounded-xl text-xl font-bold text-blue-600 outline-none">
                    </div>
                </div>
            </div>

            <!-- è¨˜å¸³è¡¨å–® -->
            <div class="bg-white p-5 rounded-2xl shadow-lg border border-blue-100 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-blue-500"></div>
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                    ğŸ“ æ–°å¢ä¸€ç­†èŠ±è²»
                </h3>
                
                <!-- Google Sheet URL è¨­å®š (åˆæ¬¡ä½¿ç”¨é¡¯ç¤º) -->
                <div id="sheet-setup-box" class="mb-4 p-3 bg-yellow-50 text-yellow-800 text-sm rounded-lg hidden">
                    <p class="font-bold mb-1">âš ï¸ å°šæœªè¨­å®š Google è©¦ç®—è¡¨é€£çµ</p>
                    <input type="text" id="sheet-url-input" placeholder="è²¼ä¸Šæ‚¨çš„ Apps Script URL" class="w-full p-2 border rounded mb-2">
                    <button onclick="saveSheetUrl()" class="bg-yellow-500 text-white px-3 py-1 rounded font-bold w-full">å„²å­˜è¨­å®š</button>
                    <p class="text-xs mt-1 text-gray-500">*è¨­å®šå¾Œæ‰èƒ½åŒæ­¥è³‡æ–™åˆ°é›²ç«¯</p>
                </div>

                <div class="space-y-3">
                    <input type="date" id="expense-date" class="input-field">
                    <input type="text" id="expense-item" placeholder="å“é … / åœ°é» (ä¾‹å¦‚ï¼šåˆé¤ã€é‹¼å½ˆæ¨¡å‹)" class="input-field">
                    <input type="number" id="expense-amount" placeholder="é‡‘é¡ (æ—¥å¹£ Â¥)" class="input-field">
                    
                    <button onclick="addExpense()" class="w-full bg-blue-600 text-white py-4 rounded-xl text-xl font-bold shadow-md hover:bg-blue-700 active:scale-95 transition">
                        æ–°å¢ç´€éŒ„
                    </button>
                </div>
            </div>

            <!-- ä»Šæ—¥èŠ±è²»åˆ—è¡¨ -->
            <div>
                <div class="flex justify-between items-end mb-3">
                    <h3 class="font-bold text-xl text-gray-700">ä»Šæ—¥èŠ±è²»</h3>
                    <span class="text-2xl font-bold text-blue-600">Â¥ <span id="total-amount">0</span></span>
                </div>
                <div id="expense-list" class="space-y-2">
                    <!-- JS ç”Ÿæˆ -->
                </div>
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <button id="sync-btn" onclick="syncToGoogleSheet()" class="bg-green-500 text-white py-3 rounded-xl font-bold shadow opacity-50 cursor-not-allowed" disabled>
                        â˜ï¸ åŒæ­¥ä¸Šå‚³
                    </button>
                    <button onclick="fetchCloudRecords()" class="bg-indigo-500 text-white py-3 rounded-xl font-bold shadow hover:bg-indigo-600">
                        ğŸ“‹ ç€è¦½ç´€éŒ„
                    </button>
                </div>
                <button onclick="toggleSetupBox()" class="text-xs text-gray-400 mt-2 w-full text-center underline">è¨­å®š Google è©¦ç®—è¡¨é€£çµ</button>
            </div>
        </div>

        <!-- 5ï¸âƒ£ å·¥å…· (Tools) -->
        <div id="view-tools" class="hidden p-5 space-y-6 fade-in pb-24">
            <!-- ç¿»è­¯æ¨¡æ“¬ -->
            <div class="bg-white p-5 rounded-2xl shadow-sm">
                <h3 class="font-bold text-gray-700 mb-3">ğŸ—£ï¸ ç¿»è­¯å°å¹«æ‰‹</h3>
                <div class="flex gap-2 mb-3">
                    <button class="flex-1 py-2 bg-blue-100 text-blue-700 rounded-lg font-bold">ä¸­ â æ—¥</button>
                    <button class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg">æ—¥ â ä¸­</button>
                </div>
                <textarea placeholder="è«‹è¼¸å…¥æ–‡å­—..." class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 h-24 mb-2 text-lg"></textarea>
                <div class="flex gap-2">
                    <button class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">ç¿»è­¯</button>
                    <button class="w-14 bg-gray-200 rounded-xl flex items-center justify-center text-2xl">ğŸ¤</button>
                    <button class="w-14 bg-gray-200 rounded-xl flex items-center justify-center text-2xl">ğŸ“·</button>
                </div>
            </div>

            <!-- é—œéµå­—å¿«æœ -->
            <div>
                <h3 class="font-bold text-xl text-gray-700 mb-3">ğŸ‡¯ğŸ‡µ å¯¦ç”¨é—œéµå­— (é»æ“Šæœå°‹åœ–ç‰‡)</h3>
                <div class="grid grid-cols-2 gap-3" id="keywords-list">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>
        </div>

    </main>

    <!-- é›²ç«¯ç´€éŒ„ Modal -->
    <div id="cloud-history-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
            <div class="bg-indigo-600 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-xl">â˜ï¸ Google è©¦ç®—è¡¨ç´€éŒ„</h3>
                <button onclick="closeCloudHistory()" class="text-white text-2xl px-2">âœ•</button>
            </div>
            <div id="cloud-history-content" class="p-4 overflow-y-auto flex-1 bg-gray-50">
                <div class="flex justify-center py-10">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div>
                </div>
            </div>
            <div class="p-3 border-t bg-white text-center text-sm text-gray-500">
                è³‡æ–™ä¾†æº: æ‚¨çš„ Google Sheet
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆª -->
    <nav class="bg-white border-t flex justify-around items-center px-1 py-2 pb-safe fixed bottom-0 w-full z-30 shadow-2xl text-gray-400">
        <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center p-2 w-full transition">
            <svg class="w-7 h-7 mb-1" viewBox="0 0 24 24"><path d="M12 3L4 9v12h5v-7h6v7h5V9z" fill="currentColor"/></svg>
            <span class="text-xs">é¦–é </span>
        </button>
        <button onclick="switchTab('map')" class="nav-item flex flex-col items-center p-2 w-full transition">
            <svg class="w-7 h-7 mb-1" viewBox="0 0 24 24"><path d="M20.5 3l-6 1.5-6-1.5L2 4.5v15l6.5-1.5 6 1.5 6-1.5v-15zm-6 12v-7l5-1.25v13.25l-5 1.25zm-11-1.25V5.25l5-1.25v13.25l-5 1.25z" fill="currentColor"/></svg>
            <span class="text-xs">åœ°åœ–</span>
        </button>
        <button onclick="switchTab('explore')" class="nav-item flex flex-col items-center p-2 w-full transition">
            <svg class="w-7 h-7 mb-1" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z" fill="currentColor"/></svg>
            <span class="text-xs">æ¢ç´¢</span>
        </button>
        <button onclick="switchTab('money')" class="nav-item flex flex-col items-center p-2 w-full transition">
            <svg class="w-7 h-7 mb-1" viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z" fill="currentColor"/></svg>
            <span class="text-xs">è¨˜å¸³</span>
        </button>
        <button onclick="switchTab('tools')" class="nav-item flex flex-col items-center p-2 w-full transition">
            <svg class="w-7 h-7 mb-1" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39.96c-.22-.08-.47 0 .59-.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" fill="currentColor"/></svg>
            <span class="text-xs">å·¥å…·</span>
        </button>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- è³‡æ–™è¨­å®š (Data) ---
        // åŒ…å«å…ˆå‰çš„æ™¯é» + æ–°å¢çš„å‹•æ¼«/è³¼ç‰©é»
        const places = [
            // åŸæœ‰çš„ (éƒ¨åˆ†)
            { id: 1, name: "å¤§é€šå…¬åœ’", type: "spot", area: "æœ­å¹Œä¸­å¿ƒ", lat: 43.0611, lng: 141.3564, note: "æœ­å¹Œåœ°æ¨™é›»è¦–å¡”", icon: "ğŸ—¼", rating: 4.5 },
            { id: 2, name: "ç‹¸å°è·¯å•†åº—è¡—", type: "shopping", area: "ç‹¸å°è·¯", lat: 43.0567, lng: 141.3542, note: "è—¥å¦ã€å”å‰è¨¶å¾·ã€ä¼´æ‰‹ç¦®", icon: "ğŸ›ï¸", rating: 4.2 },
            { id: 3, name: "äºŒæ¢å¸‚å ´", type: "food", area: "æœ­å¹Œä¸­å¿ƒ", lat: 43.0583, lng: 141.3582, note: "æµ·é®®ä¸¼é£¯æ—©é¤é¦–é¸", icon: "ğŸ¦€", rating: 4.1 },
            { id: 4, name: "å°æ¨½é‹æ²³", type: "spot", area: "å°æ¨½", lat: 43.1976, lng: 141.0028, note: "æµªæ¼«å¤œæ™¯å¿…æ‹", icon: "ğŸ›¶", rating: 4.4 },
            { id: 26, name: "ä¸‰äº• OUTLET", type: "shopping", area: "åŒ—å»£å³¶", lat: 42.9698, lng: 141.4627, note: "åç‰ŒæŠ˜æ‰£ï¼Œå¥½é€›å¥½è²·", icon: "ğŸ¬", rating: 4.1 },
            
            // æ–°å¢ï¼šå‹•æ¼«/æ¨¡å‹ (Toy)
            { id: 101, name: "Animate æœ­å¹Œåº—", type: "toy", area: "æœ­å¹Œä¸­å¿ƒ", lat: 43.0605, lng: 141.3535, note: "å¥³æ€§å‘å‘¨é‚Šå¤šï¼Œæ¼«ç•«é½Šå…¨", icon: "ğŸ“˜", rating: 4.3 },
            { id: 102, name: "Mandarake æœ­å¹Œåº—", type: "toy", area: "ç‹¸å°è·¯", lat: 43.0565, lng: 141.3525, note: "äºŒæ‰‹çµ•ç‰ˆå“æŒ–å¯¶è–åœ° (å¤§é€šå¤§æ¨“å…§)", icon: "ğŸº", rating: 4.0 },
            { id: 103, name: "é§¿æ²³å±‹ æœ­å¹Œåº—", type: "toy", area: "æœ­å¹Œè»Šç«™", lat: 43.0675, lng: 141.3510, note: "äºŒæ‰‹æ¨¡å‹å…¬ä»”åƒ¹æ ¼æ¼‚äº®", icon: "ğŸ“¦", rating: 3.9 },
            { id: 104, name: "PokÃ©mon Center Sapporo", type: "toy", area: "æœ­å¹Œè»Šç«™", lat: 43.0686, lng: 141.3508, note: "å¤§ä¸¸ç™¾è²¨ 8Fï¼Œé™å®šå¯¶å¯å¤¢å‘¨é‚Š", icon: "âš¡", rating: 4.6 },
            { id: 105, name: "Yodobashi Camera", type: "toy", area: "æœ­å¹Œè»Šç«™", lat: 43.0690, lng: 141.3480, note: "3F ç©å…·æ¨¡å‹å€æ¥µå¤§ï¼Œé‹¼å½ˆé½Šå…¨ï¼Œå…ç¨…", icon: "ğŸ¤–", rating: 4.5 },
            { id: 106, name: "Bic Camera æœ­å¹Œåº—", type: "toy", area: "æœ­å¹Œè»Šç«™", lat: 43.0670, lng: 141.3530, note: "é›»å™¨èˆ‡ç©å…·æ¨¡å‹ï¼Œå…ç¨…æ–¹ä¾¿", icon: "ğŸ“·", rating: 4.2 },
            { id: 107, name: "VOLKS æœ­å¹Œåº—", type: "toy", area: "æœ­å¹Œä¸­å¿ƒ", lat: 43.0600, lng: 141.3530, note: "IKEUCHI GATE å…§ï¼Œå°ˆæ¥­æ¨¡å‹å·¥å…·èˆ‡äººå¶", icon: "ğŸ› ï¸", rating: 4.4 },

            // æ–°å¢ï¼šè³¼ç‰© (Shopping)
            { id: 201, name: "æœ­å¹Œ PARCO", type: "shopping", area: "æœ­å¹Œä¸­å¿ƒ", lat: 43.0595, lng: 141.3530, note: "å¹´è¼•æ½®æµå“ç‰Œï¼ŒJump Shop åœ¨é€™", icon: "ğŸ‘—", rating: 4.1 },
            { id: 202, name: "Stellar Place", type: "shopping", area: "æœ­å¹Œè»Šç«™", lat: 43.0685, lng: 141.3505, note: "èˆ‡è»Šç«™å…±æ§‹ï¼Œè¶…å¤§è³¼ç‰©ä¸­å¿ƒ", icon: "ğŸ¬", rating: 4.3 },
        ];

        const webLinks = [
            { title: "æ¨‚åƒè³¼ï¼æ—¥æœ¬", desc: "åŒ—æµ·é“è‡ªç”±è¡Œæ”»ç•¥", url: "https://hokkaido.letsgojp.com/archives/659283/", icon: "ğŸ‡¯ğŸ‡µ" },
            { title: "GoodLuckTrip", desc: "åŒ—æµ·é“å¥½é‹æ—¥æœ¬è¡Œ", url: "https://www.gltjp.com/zh-hant/article/item/20775/", icon: "ğŸ€" },
            { title: "è¥¿åŒ—æ—…éŠ", desc: "åŒ—æµ·é“è³¼ç‰©æŒ‡å—", url: "https://northwest-travel.com/japan/hokkaido-travel-shopping/", icon: "ğŸ›ï¸" },
            { title: "Funliday", desc: "ç‹¸å°è·¯è¡Œç¨‹è¦åŠƒ", url: "https://www.funliday.com/posts/tanukikoji/", icon: "ğŸ“" }
        ];

        const keywords = [
            { word: "å»æ‰€", jp: "ãƒˆã‚¤ãƒ¬ (Toire)" },
            { word: "çµå¸³", jp: "ãŠä¼šè¨ˆ (O-kaikei)" },
            { word: "å¤šå°‘éŒ¢", jp: "ã„ãã‚‰ (Ikura)" },
            { word: "å…ç¨…", jp: "å…ç¨ (Menzei)" },
            { word: "æ¨è–¦", jp: "ãŠã™ã™ã‚ (Osusume)" },
            { word: "å¤–å¸¶", jp: "ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ (Take out)" },
            { word: "ä¸å¥½æ„æ€", jp: "ã™ã¿ã¾ã›ã‚“ (Sumimasen)" },
            { word: "è¬è¬", jp: "ã‚ã‚ŠãŒã¨ã† (Arigatou)" }
        ];

        // --- è®Šæ•¸èˆ‡åˆå§‹åŒ– ---
        let map;
        let markers = [];
        let expenseList = JSON.parse(localStorage.getItem('hokkaido_expenses')) || [];
        // è¨­å®šå·²çŸ¥çš„ GAS é€£çµç‚ºé è¨­å€¼
        let sheetUrl = localStorage.getItem('hokkaido_sheet_url') || "https://script.google.com/macros/s/AKfycbyGdnxRVEY4_lpRozTYUqmLKP8634VmE_LRpSKsMoTm4H4ATD8b6Bs30PLrpQF4tbE/exec";

        document.addEventListener('DOMContentLoaded', () => {
            renderLinks();
            renderKeywords();
            renderExplore(places);
            renderExpenseList();
            initMap();
            
            // é è¨­æ—¥æœŸç‚ºä»Šå¤©
            document.getElementById('expense-date').valueAsDate = new Date();
            
            if(!sheetUrl) document.getElementById('sheet-setup-box').classList.remove('hidden');

            // æœå°‹ç›£è½
            document.getElementById('search-input').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = places.filter(p => 
                    p.name.toLowerCase().includes(term) || 
                    p.note.includes(term) ||
                    p.type.includes(term)
                );
                renderExplore(filtered);
            });
        });

        // --- æ ¸å¿ƒå°èˆªé‚è¼¯ ---
        function switchTab(tabName, filterType = null) {
            ['home', 'map', 'explore', 'money', 'tools'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`view-${t}`).classList.remove('flex'); // ç¢ºä¿ flex layout è¢«ç§»é™¤
            });
            
            // é¡¯ç¤ºç›®æ¨™ tab
            const target = document.getElementById(`view-${tabName}`);
            target.classList.remove('hidden');
            if (tabName === 'map') target.classList.add('flex'); // Map éœ€è¦ flex
            
            // æ›´æ–°åº•éƒ¨å°èˆªç‹€æ…‹
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // ç°¡å–®å°æ‡‰ index: home=0, map=1, explore=2, money=3, tools=4
            const navMap = {'home':0, 'map':1, 'explore':2, 'money':3, 'tools':4};
            document.querySelectorAll('.nav-item')[navMap[tabName]].classList.add('active');

            if (tabName === 'map') {
                setTimeout(() => { 
                    map.invalidateSize(); 
                    if(filterType) filterMap(filterType);
                }, 100);
            }
            if (tabName === 'explore' && filterType) {
                filterExplore(filterType);
            }
        }

        // --- åŠŸèƒ½ 1 & 2 & 5: æ¸²æŸ“é€£çµèˆ‡é—œéµå­— ---
        function renderLinks() {
            const container = document.getElementById('links-container');
            container.innerHTML = webLinks.map(link => `
                <a href="${link.url}" target="_blank" class="flex items-center gap-3 bg-white p-4 rounded-xl shadow-sm border border-gray-100 active:bg-gray-50">
                    <div class="text-2xl bg-gray-50 w-12 h-12 flex items-center justify-center rounded-lg">${link.icon}</div>
                    <div class="flex-1">
                        <h4 class="font-bold text-blue-700">${link.title}</h4>
                        <p class="text-sm text-gray-500">${link.desc}</p>
                    </div>
                    <span class="text-gray-300">âœ</span>
                </a>
            `).join('');
        }

        function renderKeywords() {
            const container = document.getElementById('keywords-list');
            container.innerHTML = keywords.map(k => `
                <a href="https://www.google.com/search?tbm=isch&q=${k.jp}" target="_blank" class="bg-white p-3 rounded-xl shadow-sm border text-center active:bg-blue-50">
                    <div class="text-lg font-bold text-gray-800">${k.word}</div>
                    <div class="text-sm text-blue-600 mt-1">${k.jp}</div>
                </a>
            `).join('');
        }

        // --- åŠŸèƒ½ 4: è¨˜å¸³èˆ‡ Google Sheet é‚è¼¯ ---
        function calculateRate() {
            const jpy = parseFloat(document.getElementById('jpy-input').value) || 0;
            const rate = 0.22; // å›ºå®šåŒ¯ç‡ï¼Œå¯¦éš›å¯æ¥ API
            document.getElementById('twd-output').value = Math.round(jpy * rate);
        }

        function toggleSetupBox() {
            document.getElementById('sheet-setup-box').classList.toggle('hidden');
        }

        function saveSheetUrl() {
            const url = document.getElementById('sheet-url-input').value;
            if(url) {
                localStorage.setItem('hokkaido_sheet_url', url);
                sheetUrl = url;
                alert('é€£çµå·²å„²å­˜ï¼ç¾åœ¨å¯ä»¥åŒæ­¥è³‡æ–™äº†ã€‚');
                toggleSetupBox();
            }
        }

        function addExpense() {
            const date = document.getElementById('expense-date').value;
            const item = document.getElementById('expense-item').value;
            const amount = document.getElementById('expense-amount').value;

            if (!date || !item || !amount) {
                alert('è«‹å®Œæ•´å¡«å¯«æ—¥æœŸã€å“é …èˆ‡é‡‘é¡');
                return;
            }

            const record = {
                id: Date.now(),
                date: date,
                item: item,
                amount: parseInt(amount),
                synced: false
            };

            expenseList.unshift(record); // åŠ åˆ°æœ€å‰é¢
            localStorage.setItem('hokkaido_expenses', JSON.stringify(expenseList));
            
            // æ¸…ç©ºè¼¸å…¥
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amount').value = '';
            
            renderExpenseList();
            alert(`å·²è¨˜éŒ„ï¼šÂ¥${amount}`);
        }

        function addToExpenseFromCard() {
            // å¾åœ°åœ–å¡ç‰‡å¿«é€Ÿè¨˜å¸³
            const title = document.getElementById('card-title').innerText;
            document.getElementById('expense-item').value = title;
            switchTab('money');
        }

        function renderExpenseList() {
            const container = document.getElementById('expense-list');
            let total = 0;
            let unsyncedCount = 0;

            container.innerHTML = expenseList.map(ex => {
                total += ex.amount;
                if(!ex.synced) unsyncedCount++;
                
                return `
                    <div class="flex justify-between items-center bg-white p-3 rounded-xl border-l-4 ${ex.synced ? 'border-green-400' : 'border-gray-300'} shadow-sm">
                        <div>
                            <div class="font-bold text-gray-800">${ex.item}</div>
                            <div class="text-xs text-gray-500">${ex.date} ${ex.synced ? 'âœ… å·²åŒæ­¥' : 'â˜ï¸ å¾…ä¸Šå‚³'}</div>
                        </div>
                        <div class="font-bold text-lg">Â¥${ex.amount.toLocaleString()}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('total-amount').innerText = total.toLocaleString();
            
            // æ›´æ–°åŒæ­¥æŒ‰éˆ•ç‹€æ…‹
            const syncBtn = document.getElementById('sync-btn');
            if (unsyncedCount > 0 && sheetUrl) {
                syncBtn.disabled = false;
                syncBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                syncBtn.innerText = `â˜ï¸ åŒæ­¥ä¸Šå‚³ (${unsyncedCount}ç­†)`;
            } else {
                syncBtn.disabled = true;
                syncBtn.classList.add('opacity-50', 'cursor-not-allowed');
                syncBtn.innerText = sheetUrl ? 'â˜ï¸ æ‰€æœ‰è³‡æ–™å·²åŒæ­¥' : 'âš ï¸ è«‹å…ˆè¨­å®šé€£çµ';
            }
        }

        // *** Google Sheet åŒæ­¥æ ¸å¿ƒ (POST) ***
        function syncToGoogleSheet() {
            if (!sheetUrl) { alert('è«‹å…ˆè¨­å®š Google Apps Script URL'); return; }

            const unsyncedData = expenseList.filter(ex => !ex.synced);
            if (unsyncedData.length === 0) return;

            const btn = document.getElementById('sync-btn');
            btn.innerText = "â³ ä¸Šå‚³ä¸­...";
            btn.disabled = true;

            fetch(sheetUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(unsyncedData)
            }).then(() => {
                expenseList.forEach(ex => ex.synced = true);
                localStorage.setItem('hokkaido_expenses', JSON.stringify(expenseList));
                renderExpenseList();
                alert('è³‡æ–™å·²ç™¼é€è‡³ Google è©¦ç®—è¡¨ï¼');
            }).catch(err => {
                console.error(err);
                alert('åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– URL');
                btn.innerText = "åŒæ­¥å¤±æ•— (é‡è©¦)";
                btn.disabled = false;
            });
        }

        // *** ç€è¦½é›²ç«¯ç´€éŒ„ (GET) ***
        function fetchCloudRecords() {
            if (!sheetUrl) { alert('è«‹å…ˆè¨­å®š Google Apps Script URL'); return; }
            
            const modal = document.getElementById('cloud-history-modal');
            const content = document.getElementById('cloud-history-content');
            
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="flex justify-center py-10"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div></div>';
            
            fetch(sheetUrl)
                .then(response => response.json())
                .then(data => {
                    if (!data || data.length === 0) {
                        content.innerHTML = '<div class="text-center text-gray-500 py-10">é›²ç«¯è©¦ç®—è¡¨æ˜¯ç©ºçš„</div>';
                        return;
                    }
                    
                    let total = 0;
                    const html = data.map(row => {
                        const amt = parseInt(row.amount) || 0;
                        total += amt;
                        // è™•ç†æ—¥æœŸæ ¼å¼ (GAS å›å‚³é€šå¸¸æ˜¯ ISO æˆ–å­—ä¸²)
                        let dateStr = row.date;
                        if(dateStr.includes('T')) dateStr = dateStr.split('T')[0];
                        
                        return `
                            <div class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-200 mb-2 shadow-sm">
                                <div>
                                    <div class="font-bold text-gray-800">${row.item}</div>
                                    <div class="text-xs text-gray-500">${dateStr}</div>
                                </div>
                                <div class="font-bold text-indigo-600">Â¥${amt.toLocaleString()}</div>
                            </div>
                        `;
                    }).join('');
                    
                    content.innerHTML = `
                        <div class="text-right mb-4 font-bold text-gray-700">ç¸½è¨ˆ: Â¥${total.toLocaleString()}</div>
                        ${html}
                    `;
                })
                .catch(err => {
                    console.error(err);
                    content.innerHTML = `
                        <div class="text-center text-red-500 py-6">
                            è®€å–å¤±æ•—<br>
                            <span class="text-xs text-gray-500 block mt-2">è«‹ç¢ºèªæ‚¨çš„ Google Apps Script å·²æ›´æ–°ç¨‹å¼ç¢¼ä»¥æ”¯æ´ "doGet" è®€å–åŠŸèƒ½ã€‚</span>
                        </div>
                    `;
                });
        }
        
        function closeCloudHistory() {
            document.getElementById('cloud-history-modal').classList.add('hidden');
        }

        // --- åŠŸèƒ½ 1 & 2: åœ°åœ–èˆ‡æ¢ç´¢é‚è¼¯ ---
        function initMap() {
            map = L.map('map').setView([43.0618, 141.3545], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OSM'
            }).addTo(map);
            renderMarkers(places);
        }

        function renderMarkers(data) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            data.forEach(p => {
                const icon = L.divIcon({
                    className: '',
                    html: `<div style="font-size:28px; text-shadow:0 2px 4px rgba(0,0,0,0.3)">${p.icon}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                const marker = L.marker([p.lat, p.lng], {icon}).addTo(map);
                marker.on('click', () => {
                    openMapCard(p);
                    map.setView([p.lat, p.lng], 15);
                });
                markers.push(marker);
            });
        }

        function filterMap(type) {
            document.querySelectorAll('.map-filter').forEach(b => {
                if((type==='all' && b.innerText.includes('å…¨éƒ¨')) || b.innerText.includes(getCatName(type))) {
                    b.classList.add('bg-blue-600', 'text-white', 'ring-2');
                    b.classList.remove('bg-white', 'text-gray-700', 'text-blue-600');
                } else {
                    b.classList.remove('bg-blue-600', 'text-white', 'ring-2');
                    b.classList.add('bg-white', 'text-gray-700');
                }
            });
            const filtered = type === 'all' ? places : places.filter(p => p.type === type);
            renderMarkers(filtered);
        }

        function filterExplore(type) {
            document.getElementById('search-input').value = getCatName(type);
            const filtered = places.filter(p => p.type === type);
            renderExplore(filtered);
        }

        function renderExplore(list) {
            const container = document.getElementById('explore-list');
            if(list.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-10">æ‰¾ä¸åˆ°ç›¸é—œåœ°é»...</div>';
                return;
            }
            container.innerHTML = list.map(p => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex gap-4 active:bg-gray-50" onclick="locatePlace(${p.id})">
                    <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center text-4xl">${p.icon}</div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-lg">${p.name}</h4>
                            <span class="text-yellow-500 font-bold text-sm">â˜… ${p.rating}</span>
                        </div>
                        <p class="text-sm text-blue-600 font-bold mb-1">${p.area} Â· ${getCatName(p.type)}</p>
                        <p class="text-sm text-gray-500 line-clamp-1">${p.note}</p>
                    </div>
                </div>
            `).join('');
        }

        function locatePlace(id) {
            const p = places.find(x => x.id === id);
            if(p) {
                switchTab('map');
                setTimeout(() => {
                    map.setView([p.lat, p.lng], 16);
                    openMapCard(p);
                }, 300);
            }
        }

        function openMapCard(p) {
            const card = document.getElementById('map-card');
            document.getElementById('card-type').innerText = getCatName(p.type);
            document.getElementById('card-title').innerText = p.name;
            document.getElementById('card-desc').innerText = p.note;
            document.getElementById('card-google').href = `https://www.google.com/maps/search/?api=1&query=${p.name}`;
            
            card.classList.remove('hidden');
            setTimeout(() => card.classList.remove('translate-y-full'), 10);
        }

        function closeMapCard() {
            const card = document.getElementById('map-card');
            card.classList.add('translate-y-full');
            setTimeout(() => card.classList.add('hidden'), 300);
        }

        function getCatName(type) {
            const map = { 'toy': 'å‹•æ¼«ç©å…·', 'food': 'ç¾é£Ÿ', 'shopping': 'è³¼ç‰©', 'spot': 'æ™¯é»', 'store': 'è¶…å•†' };
            return map[type] || 'å…¶ä»–';
        }
    </script>
</body>
</html>

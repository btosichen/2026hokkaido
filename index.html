<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <!-- å„ªåŒ– Viewport è¨­å®šï¼Œç¦æ­¢ç¸®æ”¾ä»¥æ¨¡æ“¬åŸç”Ÿ App é«”é©—ï¼Œä¸¦ç¢ºä¿å¯¬åº¦é©é… -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ—æµ·é“ 5 å¤©æ—…éŠè¶£</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        /* è¨­å®šæ ¹å­—é«”å¤§å°ï¼Œè®“ rem å–®ä½åœ¨ä¸åŒè£ç½®ä¸Šæœ‰æ›´å¥½çš„æ¯”ä¾‹ */
        :root {
            font-size: 16px;
        }
        @media (min-width: 768px) {
            :root {
                font-size: 18px; /* å¹³æ¿ä»¥ä¸ŠåŸºç¤å­—é«”åŠ å¤§ */
            }
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F3F4F6;
            -webkit-tap-highlight-color: transparent;
            font-size: 1rem; /* ä½¿ç”¨ç›¸å°å–®ä½ */
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .nav-item.active {
            color: #2563EB;
        }
        .nav-item.active span {
            font-weight: 700;
        }

        #map {
            /* èª¿æ•´åœ°åœ–é«˜åº¦ä»¥é©æ‡‰è®Šå¤§çš„ Header/Footer */
            height: calc(100vh - 160px); 
            width: 100%;
            z-index: 0;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* åŠ å¤§é»æ“Šå€åŸŸ */
        button, a {
            touch-action: manipulation;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- é ‚éƒ¨æ¨™é¡Œåˆ— (åŠ å¤§) -->
    <header class="bg-blue-600 text-white p-5 shadow-md flex-none z-20">
        <div class="flex justify-between items-center">
            <h1 class="text-3xl font-bold flex items-center gap-2 tracking-wide">
                â„ï¸ åŒ—æµ·é“æ—…éŠè¶£
            </h1>
            <button onclick="toggleMockLocation()" class="text-base bg-white/20 px-3 py-2 rounded-lg hover:bg-white/30 transition font-medium">
                ğŸ“ æ¨¡æ“¬å®šä½
            </button>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main id="app-content" class="flex-1 overflow-y-auto relative scroll-smooth no-scrollbar bg-gray-100">
        
        <!-- 1ï¸âƒ£ é¦–é è¦–åœ– (å­—é«”åŠ å¤§ç‰ˆ) -->
        <div id="view-home" class="p-5 space-y-8 fade-in pb-32">
            <!-- æ­¡è¿å¡ç‰‡ -->
            <div class="bg-gradient-to-r from-blue-500 to-cyan-400 rounded-3xl p-6 text-white shadow-xl">
                <p class="text-lg opacity-90 font-medium">ç›®å‰ä½ç½®</p>
                <h2 id="current-location-text" class="text-4xl font-bold mt-2 tracking-tight">ğŸ‡¯ğŸ‡µ å°šæœªå®šä½</h2>
                <div class="mt-6 flex gap-4">
                    <button onclick="switchTab('map', 'food')" class="flex-1 bg-white/20 backdrop-blur-md py-3 rounded-xl text-lg font-bold hover:bg-white/30 transition shadow-sm border border-white/10">ğŸœ æ‰¾ç¾é£Ÿ</button>
                    <button onclick="switchTab('map', 'store')" class="flex-1 bg-white/20 backdrop-blur-md py-3 rounded-xl text-lg font-bold hover:bg-white/30 transition shadow-sm border border-white/10">ğŸª æ‰¾è¶…å•†</button>
                    <button onclick="switchTab('map', 'shopping')" class="flex-1 bg-white/20 backdrop-blur-md py-3 rounded-xl text-lg font-bold hover:bg-white/30 transition shadow-sm border border-white/10">ğŸ›ï¸ ä¼´æ‰‹ç¦®</button>
                </div>
            </div>

            <!-- è¡Œç¨‹æ™‚é–“è»¸ -->
            <div>
                <h3 class="font-bold text-2xl mb-4 text-gray-700 ml-1">ğŸ—“ï¸ 5 å¤©è¡Œç¨‹ç¸½è¦½</h3>
                <div class="space-y-4" id="itinerary-list">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- 2ï¸âƒ£ åœ°åœ–è¦–åœ– -->
        <div id="view-map" class="hidden h-full flex flex-col relative fade-in">
            <!-- ç¯©é¸æŒ‰éˆ• (åŠ å¤§) -->
            <div class="absolute top-4 left-0 right-0 z-[1000] px-3">
                <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2 px-1">
                    <button onclick="filterMap('all')" class="map-filter px-6 py-3 bg-white shadow-lg rounded-full text-lg whitespace-nowrap border border-gray-200 active-filter font-bold text-blue-600 ring-4 ring-blue-500/30">å…¨éƒ¨</button>
                    <button onclick="filterMap('food')" class="map-filter px-6 py-3 bg-white shadow-lg rounded-full text-lg whitespace-nowrap border border-gray-200 text-gray-700">ğŸœ ç¾é£Ÿ</button>
                    <button onclick="filterMap('spot')" class="map-filter px-6 py-3 bg-white shadow-lg rounded-full text-lg whitespace-nowrap border border-gray-200 text-gray-700">ğŸ“¸ æ™¯é»</button>
                    <button onclick="filterMap('shopping')" class="map-filter px-6 py-3 bg-white shadow-lg rounded-full text-lg whitespace-nowrap border border-gray-200 text-gray-700">ğŸ›ï¸ è³¼ç‰©</button>
                    <button onclick="filterMap('store')" class="map-filter px-6 py-3 bg-white shadow-lg rounded-full text-lg whitespace-nowrap border border-gray-200 text-gray-700">ğŸª è¶…å•†</button>
                </div>
            </div>
            
            <div id="map" class="w-full h-full bg-gray-200"></div>

            <!-- åº•éƒ¨è³‡è¨Šå¡ (åŠ å¤§) -->
            <div id="map-card" class="absolute bottom-6 left-4 right-4 bg-white p-6 rounded-2xl shadow-2xl z-[1000] hidden transform transition-all duration-300 translate-y-0 border border-gray-100">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1 pr-4">
                        <span id="card-type" class="text-base font-bold px-3 py-1 rounded-md bg-blue-100 text-blue-700 inline-block mb-2">é¡å‹</span>
                        <h3 id="card-title" class="text-2xl font-bold text-gray-900 leading-tight">åœ°é»åç¨±</h3>
                    </div>
                    <button onclick="closeMapCard()" class="text-gray-400 hover:text-gray-600 p-2 -mr-2 -mt-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <p id="card-desc" class="text-lg text-gray-600 mb-6 line-clamp-3 leading-relaxed">æè¿°</p>
                
                <div class="flex gap-3">
                    <a id="card-google-btn" href="#" target="_blank" class="flex-1 bg-blue-600 text-white text-center py-4 rounded-xl text-lg font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition flex items-center justify-center gap-2">
                        <span>ğŸ—ºï¸</span> Google å°èˆª
                    </a>
                    <button id="card-fav-btn" class="px-5 py-3 border-2 border-gray-200 rounded-xl text-2xl text-gray-400 hover:bg-gray-50 active:scale-95 transition">
                        ğŸ¤
                    </button>
                </div>
            </div>
        </div>

        <!-- 3ï¸âƒ£ æ¢ç´¢è¦–åœ– (åŠ å¤§) -->
        <div id="view-explore" class="hidden p-5 space-y-6 fade-in pb-32">
            <h2 class="text-3xl font-bold text-gray-800">ğŸ” æ¢ç´¢é¡åˆ¥</h2>
            
            <div class="relative">
                <input type="text" id="search-input" placeholder="æœå°‹æ‹‰éºµã€ä¼´æ‰‹ç¦®..." class="w-full p-4 pl-12 rounded-2xl border border-gray-200 shadow-sm bg-white focus:ring-4 focus:ring-blue-200 outline-none text-xl">
                <span class="absolute left-4 top-5 text-gray-400 text-xl">ğŸ”</span>
            </div>

            <!-- ç†±é–€é—œéµå­— (åŠ å¤§) -->
            <div class="flex gap-3 overflow-x-auto no-scrollbar py-2">
                <button onclick="quickSearch('æ‹‰éºµ')" class="px-5 py-2 bg-yellow-100 text-yellow-900 rounded-full text-base font-bold whitespace-nowrap border border-yellow-200 shadow-sm">ğŸœ æ‹‰éºµ</button>
                <button onclick="quickSearch('å£½å¸')" class="px-5 py-2 bg-blue-100 text-blue-900 rounded-full text-base font-bold whitespace-nowrap border border-blue-200 shadow-sm">ğŸ£ å£½å¸</button>
                <button onclick="quickSearch('æ¹¯å’–å“©')" class="px-5 py-2 bg-orange-100 text-orange-900 rounded-full text-base font-bold whitespace-nowrap border border-orange-200 shadow-sm">ğŸ› æ¹¯å’–å“©</button>
                <button onclick="quickSearch('ç”œé»')" class="px-5 py-2 bg-pink-100 text-pink-900 rounded-full text-base font-bold whitespace-nowrap border border-pink-200 shadow-sm">ğŸ° ç”œé»</button>
            </div>

            <!-- åˆ†é¡æ¨™ç±¤ (åŠ å¤§) -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-orange-50 border border-orange-100 p-5 rounded-2xl cursor-pointer hover:bg-orange-100 transition shadow-sm active:scale-95 transform duration-200" onclick="showCategory('food')">
                    <span class="text-5xl block mb-2">ğŸ›</span>
                    <span class="font-bold text-orange-900 text-xl">å¿…åƒç¾é£Ÿ</span>
                </div>
                <div class="bg-pink-50 border border-pink-100 p-5 rounded-2xl cursor-pointer hover:bg-pink-100 transition shadow-sm active:scale-95 transform duration-200" onclick="showCategory('shopping')">
                    <span class="text-5xl block mb-2">ğŸ›ï¸</span>
                    <span class="font-bold text-pink-900 text-xl">è³¼ç‰©è¡€æ‹¼</span>
                </div>
                <div class="bg-green-50 border border-green-100 p-5 rounded-2xl cursor-pointer hover:bg-green-100 transition shadow-sm active:scale-95 transform duration-200" onclick="showCategory('spot')">
                    <span class="text-5xl block mb-2">ğŸ—»</span>
                    <span class="font-bold text-green-900 text-xl">è‡ªç„¶æ™¯è§€</span>
                </div>
                <div class="bg-blue-50 border border-blue-100 p-5 rounded-2xl cursor-pointer hover:bg-blue-100 transition shadow-sm active:scale-95 transform duration-200" onclick="showCategory('store')">
                    <span class="text-5xl block mb-2">ğŸª</span>
                    <span class="font-bold text-blue-900 text-xl">è¶…å•†è£œçµ¦</span>
                </div>
            </div>

            <div id="explore-list" class="space-y-4 mt-6">
                <!-- JS ç”Ÿæˆ -->
            </div>
        </div>

    </main>

    <!-- åº•éƒ¨å°èˆªæ¬„ (åŠ å¤§è§¸æ§å€) -->
    <nav class="bg-white border-t border-gray-200 flex justify-around items-center px-2 py-3 pb-safe fixed bottom-0 w-full z-30 shadow-[0_-4px_15px_-3px_rgba(0,0,0,0.1)]">
        <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center p-2 w-full text-gray-400 hover:text-blue-600 transition active:scale-90">
            <svg class="w-8 h-8 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span class="text-base font-medium">é¦–é </span>
        </button>
        <button onclick="switchTab('map')" class="nav-item flex flex-col items-center p-2 w-full text-gray-400 hover:text-blue-600 transition active:scale-90">
            <svg class="w-8 h-8 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0121 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
            <span class="text-base font-medium">åœ°åœ–</span>
        </button>
        <button onclick="switchTab('explore')" class="nav-item flex flex-col items-center p-2 w-full text-gray-400 hover:text-blue-600 transition active:scale-90">
            <svg class="w-8 h-8 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            <span class="text-base font-medium">æ¢ç´¢</span>
        </button>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const hokkaidoPlaces = [
            { id: 1, name: "å¤§é€šå…¬åœ’ (é›»è¦–å¡”)", type: "spot", city: "æœ­å¹Œ", lat: 43.0611, lng: 141.3564, note: "æœ­å¹Œçš„åœ°æ¨™ï¼Œå¿…æ‹é›»è¦–å¡”ï¼Œå†¬å¤©æœ‰é›ªç¥­ã€‚", icon: "ğŸ—¼" },
            { id: 2, name: "ç‹¸å°è·¯å•†åº—è¡—", type: "shopping", city: "æœ­å¹Œ", lat: 43.0567, lng: 141.3542, note: "è¶…é•·å•†åº—è¡—ï¼Œè—¥å¦åº—ã€å”å‰è¨¶å¾·éƒ½åœ¨é€™ã€‚", icon: "ğŸ›ï¸" },
            { id: 3, name: "Seicomart (å¤§é€šåº—)", type: "store", city: "æœ­å¹Œ", lat: 43.0590, lng: 141.3510, note: "åŒ—æµ·é“ç¥ç´šè¶…å•†ï¼å¿…åƒç‚¸é›èˆ‡å“ˆå¯†ç“œå†°ã€‚", icon: "ğŸª" },
            { id: 4, name: "å°æ¨½é‹æ²³", type: "spot", city: "å°æ¨½", lat: 43.1976, lng: 141.0028, note: "æµªæ¼«çš„é‹æ²³å¤œæ™¯ï¼Œæ—é‚Šæœ‰å¾ˆå¤šç»ç’ƒé¤¨ã€‚", icon: "ğŸ›¶" },
            { id: 5, name: "LeTAO æœ¬åº—", type: "food", city: "å°æ¨½", lat: 43.1912, lng: 141.0065, note: "é›™å±¤ä¹³é…ªè›‹ç³•æ˜¯æ¥µå“ï¼Œä¸€å®šè¦è©¦åƒã€‚", icon: "ğŸ°" },
            { id: 6, name: "å‡½é¤¨å±±å¤œæ™¯", type: "spot", city: "å‡½é¤¨", lat: 41.7600, lng: 140.7143, note: "ä¸–ç•Œä¸‰å¤§å¤œæ™¯ä¹‹ä¸€ï¼Œçºœè»Šä¸Šå±±å¾ˆå£¯è§€ã€‚", icon: "ğŸŒƒ" },
            { id: 7, name: "å¹¸é‹å°ä¸‘æ¼¢å ¡", type: "food", city: "å‡½é¤¨", lat: 41.7656, lng: 140.7176, note: "åªæœ‰å‡½é¤¨æ‰æœ‰çš„æ¼¢å ¡åº—ï¼Œä»½é‡è¶…å¤§ã€‚", icon: "ğŸ”" },
            { id: 8, name: "æ—­å±±å‹•ç‰©åœ’", type: "spot", city: "æ—­å·", lat: 43.7667, lng: 142.4800, note: "å†¬å¤©å¯ä»¥çœ‹åˆ°ä¼éµæ•£æ­¥ï¼", icon: "ğŸ§" },
            { id: 9, name: "æˆå‰æ€æ±—çƒ¤è‚‰", type: "food", city: "æœ­å¹Œ", lat: 43.0551, lng: 141.3514, note: "åŒ—æµ·é“å¿…åƒç¾Šè‚‰ç‡’çƒ¤ï¼Œé…å•¤é…’çµ•è®šã€‚", icon: "ğŸ¥©" },
            { id: 10, name: "æ–°åƒæ­²æ©Ÿå ´", type: "shopping", city: "åƒæ­²", lat: 42.7875, lng: 141.6814, note: "è¶…å¥½é€›çš„æ©Ÿå ´ï¼Œæœ€å¾Œè£œè²¨éƒ½åœ¨é€™ã€‚", icon: "âœˆï¸" },
            { id: 11, name: "åŒ—æµ·é“ç¥å®®", type: "spot", city: "æœ­å¹Œ", lat: 43.0545, lng: 141.3078, note: "åŒ—æµ·é“ç¸½é®å®ˆï¼Œç’°å¢ƒæ¸…å¹½ï¼Œé©åˆæ•£æ­¥åƒæ‹œã€‚", icon: "â›©ï¸" },
            { id: 12, name: "æœ­å¹Œå·¥å» ", type: "shopping", city: "æœ­å¹Œ", lat: 43.0651, lng: 141.3655, note: "ç´…ç£šå»ºç¯‰æ”¹å»ºçš„è³¼ç‰©ä¸­å¿ƒï¼Œæ°›åœå¾ˆå¥½ã€‚", icon: "ğŸ­" },
            { id: 13, name: "ç™½è‰²æˆ€äººå…¬åœ’", type: "spot", city: "æœ­å¹Œ", lat: 43.0886, lng: 141.2707, note: "åƒè§€é¤…ä¹¾ç”Ÿç”¢ç·šï¼Œé‚„æœ‰æ­é¢¨åº­åœ’å¯ä»¥æ‹ç…§ã€‚", icon: "ğŸª" },
            { id: 14, name: "ä¸€å¹»æ‹‰éºµ (ç¸½æœ¬åº—)", type: "food", city: "æœ­å¹Œ", lat: 43.0506, lng: 141.3508, note: "è¶…æ¿ƒéƒç”œè¦æ¹¯é ­æ‹‰éºµï¼Œæ’éšŠååº—ã€‚", icon: "ğŸœ" },
            { id: 15, name: "ä¿¡ç„æ‹‰éºµ (å—6æ¢åº—)", type: "food", city: "æœ­å¹Œ", lat: 43.0525, lng: 141.3475, note: "åœ¨åœ°äººä¹Ÿæ„›çš„å‘³å™Œæ‹‰éºµï¼Œç‚’é£¯ä¹Ÿæ˜¯å¿…é»ã€‚", icon: "ğŸœ" },
            { id: 16, name: "æ ¹å®¤èŠ±ä¸¸ (JRå¡”åº—)", type: "food", city: "æœ­å¹Œ", lat: 43.0686, lng: 141.3508, note: "CPå€¼è¶…é«˜çš„è¿´è½‰å£½å¸ï¼Œå°±åœ¨è»Šç«™æ¨“ä¸Šã€‚", icon: "ğŸ£" },
            { id: 17, name: "Toriton è¿´è½‰å£½å¸", type: "food", city: "æœ­å¹Œ", lat: 43.0585, lng: 141.3835, note: "é£Ÿææ–°é®®å¤§å¡Šï¼Œæœ¬åœ°äººæœ€æ¨è–¦çš„å£½å¸åº—ã€‚", icon: "ğŸ£" },
            { id: 18, name: "å‡½å¤ªéƒè¿´è½‰å£½å¸", type: "food", city: "å‡½é¤¨", lat: 41.7828, lng: 140.7554, note: "å‡½é¤¨èµ·å®¶çš„äººæ°£å£½å¸ï¼Œé è¿‘æµ·é‚Šé¢¨æ™¯å¥½ã€‚", icon: "ğŸ£" },
            { id: 19, name: "Suage+ æ¹¯å’–å“©", type: "food", city: "æœ­å¹Œ", lat: 43.0555, lng: 141.3533, note: "çŸ¥åºŠé›è‚‰ä¸²æ¹¯å’–å“©ï¼Œæœ­å¹Œå¿…åƒç¾é£Ÿã€‚", icon: "ğŸ›" }
        ];

        const itinerary = [
            { day: "Day 1", title: "æŠµé”æœ­å¹Œ", desc: "å¸‚å€è§€å…‰èˆ‡æ¡è²·è£œçµ¦", color: "bg-blue-100", spots: [1, 2, 9] },
            { day: "Day 2", title: "å°æ¨½æµªæ¼«éŠ", desc: "é‹æ²³æ•£ç­–èˆ‡ç”œé»ä¹‹æ—…", color: "bg-pink-100", spots: [4, 5] },
            { day: "Day 3", title: "æœ­å¹Œåå‹å·¡ç¦®", desc: "ç¥å®®åƒæ‹œèˆ‡è§€å…‰å·¥å» ä¸€æ—¥éŠ", color: "bg-green-100", spots: [11, 12, 13, 2] },
            { day: "Day 4", title: "ç§»å‹•è‡³å‡½é¤¨", desc: "æ¬£è³ç™¾è¬å¤œæ™¯", color: "bg-purple-100", spots: [6, 7] },
            { day: "Day 5", title: "æœ€å¾Œè¡åˆº", desc: "æ©Ÿå ´å¤§æ¡è³¼", color: "bg-orange-100", spots: [10] }
        ];

        let map;
        let markers = [];
        let userFavorites = new Set();

        document.addEventListener('DOMContentLoaded', () => {
            renderItinerary();
            renderExploreList(hokkaidoPlaces);
            initMap();
            
            document.getElementById('search-input').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = hokkaidoPlaces.filter(p => p.name.toLowerCase().includes(term) || p.note.includes(term));
                renderExploreList(filtered);
            });
        });

        function switchTab(tabName, filterType = null) {
            ['home', 'map', 'explore'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
            });
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            
            const navIndex = tabName === 'home' ? 0 : tabName === 'map' ? 1 : 2;
            document.querySelectorAll('.nav-item')[navIndex].classList.add('active');

            if (tabName === 'map') {
                setTimeout(() => {
                    map.invalidateSize();
                    if (filterType) filterMap(filterType);
                }, 100);
            }
        }

        function renderItinerary() {
            const list = document.getElementById('itinerary-list');
            list.innerHTML = itinerary.map((item, index) => {
                const spotNames = item.spots.map(id => {
                    const place = hokkaidoPlaces.find(p => p.id === id);
                    return place ? `<span class="text-base bg-white/60 px-2 py-1 rounded-md mr-1 inline-block mt-1 border border-gray-100 text-gray-700">${place.icon} ${place.name}</span>` : '';
                }).join('');

                return `
                    <div class="flex items-stretch gap-4">
                        <div class="flex flex-col items-center">
                            <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-xl shadow-md z-10">${index + 1}</div>
                            <div class="w-1 bg-gray-200 flex-1 -my-2 rounded-full"></div>
                        </div>
                        <div class="flex-1 ${item.color} p-5 rounded-2xl mb-4 shadow-sm cursor-pointer hover:shadow-md transition border border-black/5 active:scale-[0.98]" onclick="showDayDetail(${index})">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-xl text-gray-900">${item.day}ï¼š${item.title}</h4>
                            </div>
                            <p class="text-lg text-gray-700 mt-2 mb-3 leading-relaxed">${item.desc}</p>
                            <div class="flex flex-wrap gap-1">
                                ${spotNames}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showDayDetail(dayIndex) {
            const firstSpotId = itinerary[dayIndex].spots[0];
            const spot = hokkaidoPlaces.find(p => p.id === firstSpotId);
            if (spot) {
                switchTab('map');
                setTimeout(() => {
                    map.setView([spot.lat, spot.lng], 14);
                    openMapCard(spot);
                }, 300);
            }
        }

        function initMap() {
            map = L.map('map').setView([43.0618, 141.3545], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
            renderMarkers(hokkaidoPlaces);
        }

        function renderMarkers(places) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            places.forEach(place => {
                const myIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="font-size: 32px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); cursor: pointer;">${place.icon}</div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                const marker = L.marker([place.lat, place.lng], { icon: myIcon }).addTo(map);
                marker.on('click', () => {
                    openMapCard(place);
                    map.setView([place.lat, place.lng], 15);
                });
                markers.push(marker);
            });
        }

        function filterMap(type) {
            document.querySelectorAll('.map-filter').forEach(btn => {
                if ((type === 'all' && btn.innerText.includes('å…¨éƒ¨')) || btn.innerText.includes(getCategoryName(type))) {
                    btn.classList.add('active-filter', 'font-bold', 'text-blue-600', 'ring-4', 'ring-blue-500/30');
                    btn.classList.remove('text-gray-700');
                } else {
                    btn.classList.remove('active-filter', 'font-bold', 'text-blue-600', 'ring-4', 'ring-blue-500/30');
                    btn.classList.add('text-gray-700');
                }
            });

            const filtered = type === 'all' ? hokkaidoPlaces : hokkaidoPlaces.filter(p => p.type === type);
            renderMarkers(filtered);
            if (filtered.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function openMapCard(place) {
            const card = document.getElementById('map-card');
            const googleUrl = `https://www.google.com/maps/search/?api=1&query=${place.lat},${place.lng}`;
            
            document.getElementById('card-type').innerText = getCategoryName(place.type);
            document.getElementById('card-title').innerText = `${place.icon} ${place.name}`;
            document.getElementById('card-desc').innerText = place.note;
            document.getElementById('card-google-btn').href = googleUrl;
            
            const favBtn = document.getElementById('card-fav-btn');
            updateFavBtnStyle(favBtn, place.id);
            favBtn.onclick = () => toggleFavorite(place.id, favBtn);

            card.classList.remove('hidden');
            setTimeout(() => card.classList.remove('translate-y-full'), 10);
        }

        function closeMapCard() {
            const card = document.getElementById('map-card');
            card.classList.add('translate-y-full');
            setTimeout(() => card.classList.add('hidden'), 300);
        }

        function renderExploreList(list) {
            const container = document.getElementById('explore-list');
            if (list.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-12 text-xl font-medium">æ‰¾ä¸åˆ°åœ°é»...<br>è©¦è©¦çœ‹æœå°‹ã€Œæ‹‰éºµã€æˆ–ã€Œå£½å¸ã€ï¼Ÿ</div>';
                return;
            }

            container.innerHTML = list.map(place => {
                const isFav = userFavorites.has(place.id);
                return `
                    <div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center border border-gray-100 active:scale-[0.98] transition" onclick="locatePlace(${place.id})">
                        <div class="flex items-center gap-4">
                            <div class="text-5xl bg-gray-50 w-16 h-16 flex items-center justify-center rounded-xl">${place.icon}</div>
                            <div>
                                <h4 class="font-bold text-xl text-gray-900">${place.name}</h4>
                                <p class="text-base text-gray-500 mt-1">${place.city} Â· ${getCategoryName(place.type)}</p>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); toggleFavorite(${place.id}, this)" class="text-3xl p-2 transition ${isFav ? 'text-red-500 transform scale-110' : 'text-gray-300'}">
                            ${isFav ? 'â¤ï¸' : 'ğŸ¤'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function showCategory(type) {
            document.getElementById('search-input').value = getCategoryName(type);
            const filtered = hokkaidoPlaces.filter(p => p.type === type);
            renderExploreList(filtered);
        }

        function quickSearch(keyword) {
            document.getElementById('search-input').value = keyword;
            const term = keyword.toLowerCase();
            const filtered = hokkaidoPlaces.filter(p => p.name.toLowerCase().includes(term) || p.note.includes(term) || p.type.includes(term));
            renderExploreList(filtered);
        }

        function locatePlace(id) {
            const place = hokkaidoPlaces.find(p => p.id === id);
            if(place) {
                switchTab('map');
                setTimeout(() => {
                    map.setView([place.lat, place.lng], 15);
                    openMapCard(place);
                }, 300);
            }
        }

        function getCategoryName(type) {
            const map = { 'food': 'ç¾é£Ÿ', 'shopping': 'è³¼ç‰©', 'spot': 'æ™¯é»', 'store': 'è¶…å•†' };
            return map[type] || 'å…¶ä»–';
        }

        function toggleFavorite(id, btnElement) {
            if (userFavorites.has(id)) {
                userFavorites.delete(id);
                if (btnElement.tagName === 'BUTTON') {
                    btnElement.innerText = 'ğŸ¤';
                    btnElement.classList.remove('text-red-500', 'scale-110');
                    btnElement.classList.add('text-gray-300');
                }
            } else {
                userFavorites.add(id);
                if (btnElement.tagName === 'BUTTON') {
                    btnElement.innerText = 'â¤ï¸';
                    btnElement.classList.remove('text-gray-300');
                    btnElement.classList.add('text-red-500', 'scale-110');
                }
            }
        }

        function toggleMockLocation() {
            const el = document.getElementById('current-location-text');
            if (el.innerText.includes('æœ­å¹Œ')) {
                el.innerText = 'ğŸ‡¯ğŸ‡µ å°šæœªå®šä½';
            } else {
                el.innerText = 'ğŸ“ æœ­å¹Œå¸‚ä¸­å¤®å€';
                if(map) map.setView([43.0611, 141.3564], 14);
            }
        }
        
        function updateFavBtnStyle(btn, id) {
            if (userFavorites.has(id)) {
                btn.innerText = 'â¤ï¸';
                btn.classList.add('bg-red-50', 'border-red-200');
            } else {
                btn.innerText = 'ğŸ¤';
                btn.classList.remove('bg-red-50', 'border-red-200');
            }
        }
    </script>
</body>
</html>
